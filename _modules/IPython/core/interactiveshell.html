

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>IPython.core.interactiveshell &mdash; tenjint 1.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/logo.png"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpi.html">tenjint Raspberry Pi 4 Image</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">tenjint</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>IPython.core.interactiveshell</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for IPython.core.interactiveshell</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Main IPython class.&quot;&quot;&quot;</span>

<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1">#  Copyright (C) 2001 Janko Hauser &lt;jhauser@zscout.de&gt;</span>
<span class="c1">#  Copyright (C) 2001-2007 Fernando Perez. &lt;fperez@colorado.edu&gt;</span>
<span class="c1">#  Copyright (C) 2008-2011  The IPython Development Team</span>
<span class="c1">#</span>
<span class="c1">#  Distributed under the terms of the BSD License.  The full license is in</span>
<span class="c1">#  the file COPYING, distributed as part of this software.</span>
<span class="c1">#-----------------------------------------------------------------------------</span>


<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">builtins</span> <span class="k">as</span> <span class="nn">builtin_mod</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">runpy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">io_open</span>

<span class="kn">from</span> <span class="nn">pickleshare</span> <span class="k">import</span> <span class="n">PickleShareDB</span>

<span class="kn">from</span> <span class="nn">traitlets.config.configurable</span> <span class="k">import</span> <span class="n">SingletonConfigurable</span>
<span class="kn">from</span> <span class="nn">IPython.core</span> <span class="k">import</span> <span class="n">oinspect</span>
<span class="kn">from</span> <span class="nn">IPython.core</span> <span class="k">import</span> <span class="n">magic</span>
<span class="kn">from</span> <span class="nn">IPython.core</span> <span class="k">import</span> <span class="n">page</span>
<span class="kn">from</span> <span class="nn">IPython.core</span> <span class="k">import</span> <span class="n">prefilter</span>
<span class="kn">from</span> <span class="nn">IPython.core</span> <span class="k">import</span> <span class="n">ultratb</span>
<span class="kn">from</span> <span class="nn">IPython.core.alias</span> <span class="k">import</span> <span class="n">Alias</span><span class="p">,</span> <span class="n">AliasManager</span>
<span class="kn">from</span> <span class="nn">IPython.core.autocall</span> <span class="k">import</span> <span class="n">ExitAutocall</span>
<span class="kn">from</span> <span class="nn">IPython.core.builtin_trap</span> <span class="k">import</span> <span class="n">BuiltinTrap</span>
<span class="kn">from</span> <span class="nn">IPython.core.events</span> <span class="k">import</span> <span class="n">EventManager</span><span class="p">,</span> <span class="n">available_events</span>
<span class="kn">from</span> <span class="nn">IPython.core.compilerop</span> <span class="k">import</span> <span class="n">CachingCompiler</span><span class="p">,</span> <span class="n">check_linecache_ipython</span>
<span class="kn">from</span> <span class="nn">IPython.core.debugger</span> <span class="k">import</span> <span class="n">Pdb</span>
<span class="kn">from</span> <span class="nn">IPython.core.display_trap</span> <span class="k">import</span> <span class="n">DisplayTrap</span>
<span class="kn">from</span> <span class="nn">IPython.core.displayhook</span> <span class="k">import</span> <span class="n">DisplayHook</span>
<span class="kn">from</span> <span class="nn">IPython.core.displaypub</span> <span class="k">import</span> <span class="n">DisplayPublisher</span>
<span class="kn">from</span> <span class="nn">IPython.core.error</span> <span class="k">import</span> <span class="n">InputRejected</span><span class="p">,</span> <span class="n">UsageError</span>
<span class="kn">from</span> <span class="nn">IPython.core.extensions</span> <span class="k">import</span> <span class="n">ExtensionManager</span>
<span class="kn">from</span> <span class="nn">IPython.core.formatters</span> <span class="k">import</span> <span class="n">DisplayFormatter</span>
<span class="kn">from</span> <span class="nn">IPython.core.history</span> <span class="k">import</span> <span class="n">HistoryManager</span>
<span class="kn">from</span> <span class="nn">IPython.core.inputsplitter</span> <span class="k">import</span> <span class="n">ESC_MAGIC</span><span class="p">,</span> <span class="n">ESC_MAGIC2</span>
<span class="kn">from</span> <span class="nn">IPython.core.logger</span> <span class="k">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">IPython.core.macro</span> <span class="k">import</span> <span class="n">Macro</span>
<span class="kn">from</span> <span class="nn">IPython.core.payload</span> <span class="k">import</span> <span class="n">PayloadManager</span>
<span class="kn">from</span> <span class="nn">IPython.core.prefilter</span> <span class="k">import</span> <span class="n">PrefilterManager</span>
<span class="kn">from</span> <span class="nn">IPython.core.profiledir</span> <span class="k">import</span> <span class="n">ProfileDir</span>
<span class="kn">from</span> <span class="nn">IPython.core.usage</span> <span class="k">import</span> <span class="n">default_banner</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="k">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">IPython.testing.skipdoctest</span> <span class="k">import</span> <span class="n">skip_doctest</span>
<span class="kn">from</span> <span class="nn">IPython.utils</span> <span class="k">import</span> <span class="n">PyColorize</span>
<span class="kn">from</span> <span class="nn">IPython.utils</span> <span class="k">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">IPython.utils</span> <span class="k">import</span> <span class="n">py3compat</span>
<span class="kn">from</span> <span class="nn">IPython.utils</span> <span class="k">import</span> <span class="n">openpy</span>
<span class="kn">from</span> <span class="nn">IPython.utils.decorators</span> <span class="k">import</span> <span class="n">undoc</span>
<span class="kn">from</span> <span class="nn">IPython.utils.io</span> <span class="k">import</span> <span class="n">ask_yes_no</span>
<span class="kn">from</span> <span class="nn">IPython.utils.ipstruct</span> <span class="k">import</span> <span class="n">Struct</span>
<span class="kn">from</span> <span class="nn">IPython.paths</span> <span class="k">import</span> <span class="n">get_ipython_dir</span>
<span class="kn">from</span> <span class="nn">IPython.utils.path</span> <span class="k">import</span> <span class="n">get_home_dir</span><span class="p">,</span> <span class="n">get_py_filename</span><span class="p">,</span> <span class="n">ensure_dir_exists</span>
<span class="kn">from</span> <span class="nn">IPython.utils.process</span> <span class="k">import</span> <span class="n">system</span><span class="p">,</span> <span class="n">getoutput</span>
<span class="kn">from</span> <span class="nn">IPython.utils.strdispatch</span> <span class="k">import</span> <span class="n">StrDispatch</span>
<span class="kn">from</span> <span class="nn">IPython.utils.syspathcontext</span> <span class="k">import</span> <span class="n">prepended_to_syspath</span>
<span class="kn">from</span> <span class="nn">IPython.utils.text</span> <span class="k">import</span> <span class="n">format_screen</span><span class="p">,</span> <span class="n">LSString</span><span class="p">,</span> <span class="n">SList</span><span class="p">,</span> <span class="n">DollarFormatter</span>
<span class="kn">from</span> <span class="nn">IPython.utils.tempdir</span> <span class="k">import</span> <span class="n">TemporaryDirectory</span>
<span class="kn">from</span> <span class="nn">traitlets</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Integer</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">CaselessStrEnum</span><span class="p">,</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">,</span> <span class="n">Instance</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span>
    <span class="n">observe</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="k">import</span> <span class="n">error</span>
<span class="kn">import</span> <span class="nn">IPython.core.hooks</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span> <span class="k">as</span> <span class="n">ListType</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="k">import</span> <span class="n">AST</span>

<span class="c1"># NoOpContext is deprecated, but ipykernel imports it from here.</span>
<span class="c1"># See https://github.com/ipython/ipykernel/issues/157</span>
<span class="kn">from</span> <span class="nn">IPython.utils.contexts</span> <span class="k">import</span> <span class="n">NoOpContext</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">docrepr.sphinxify</span> <span class="k">as</span> <span class="nn">sphx</span>

    <span class="k">def</span> <span class="nf">sphinxify</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">dirname</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;text/html&#39;</span><span class="p">:</span> <span class="n">sphx</span><span class="o">.</span><span class="n">sphinxify</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">dirname</span><span class="p">),</span>
                <span class="s1">&#39;text/plain&#39;</span><span class="p">:</span> <span class="n">doc</span>
            <span class="p">}</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">sphinxify</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">ProvisionalWarning</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Warning class for unstable features</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">_assign_nodes</span>         <span class="o">=</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">AugAssign</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">)</span>
    <span class="n">_single_targets_nodes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">AugAssign</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_assign_nodes</span>         <span class="o">=</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">AugAssign</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span> <span class="p">)</span>
    <span class="n">_single_targets_nodes</span> <span class="o">=</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">AugAssign</span><span class="p">,</span> <span class="p">)</span>

<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># Globals</span>
<span class="c1">#-----------------------------------------------------------------------------</span>

<span class="c1"># compiled regexps for autoindent management</span>
<span class="n">dedent_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s+raise|^\s+return|^\s+pass&#39;</span><span class="p">)</span>

<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># Utilities</span>
<span class="c1">#-----------------------------------------------------------------------------</span>

<span class="nd">@undoc</span>
<span class="k">def</span> <span class="nf">softspace</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">newvalue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copied from code.py, to remove the dependency&quot;&quot;&quot;</span>

    <span class="n">oldvalue</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">oldvalue</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">softspace</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">softspace</span> <span class="o">=</span> <span class="n">newvalue</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="c1"># &quot;attribute-less object&quot; or &quot;read-only attributes&quot;</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">oldvalue</span>

<span class="nd">@undoc</span>
<span class="k">def</span> <span class="nf">no_op</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SpaceInInput</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>


<span class="k">def</span> <span class="nf">get_default_colors</span><span class="p">():</span>
    <span class="s2">&quot;DEPRECATED&quot;</span>
    <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;get_default_color is deprecated since IPython 5.0, and returns `Neutral` on all platforms.&#39;</span><span class="p">,</span>
        <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;Neutral&#39;</span>


<span class="k">class</span> <span class="nc">SeparateUnicode</span><span class="p">(</span><span class="n">Unicode</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;A Unicode subclass to validate separate_in, separate_out, etc.</span>

<span class="sd">    This is a Unicode based trait that converts &#39;0&#39;-&gt;&#39;&#39; and ``&#39;\\n&#39;-&gt;&#39;\n&#39;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SeparateUnicode</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="nd">@undoc</span>
<span class="k">class</span> <span class="nc">DummyMod</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A dummy module used for IPython&#39;s interactive module when</span>
<span class="sd">    a namespace must be assigned to the module&#39;s __dict__.&quot;&quot;&quot;</span>
    <span class="n">__spec__</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">ExecutionInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The arguments used for a call to :meth:`InteractiveShell.run_cell`</span>

<span class="sd">    Stores information about what is going to happen.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raw_cell</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">store_history</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">shell_futures</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_cell</span><span class="p">,</span> <span class="n">store_history</span><span class="p">,</span> <span class="n">silent</span><span class="p">,</span> <span class="n">shell_futures</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_cell</span> <span class="o">=</span> <span class="n">raw_cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_history</span> <span class="o">=</span> <span class="n">store_history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="n">silent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell_futures</span> <span class="o">=</span> <span class="n">shell_futures</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span>
        <span class="n">raw_cell</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_cell</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;..&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_cell</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> object at </span><span class="si">%x</span><span class="s1">, raw_cell=&quot;</span><span class="si">%s</span><span class="s1">&quot; store_history=</span><span class="si">%s</span><span class="s1"> silent=</span><span class="si">%s</span><span class="s1"> shell_futures=</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span>\
               <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">raw_cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_history</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell_futures</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ExecutionResult</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The result of a call to :meth:`InteractiveShell.run_cell`</span>

<span class="sd">    Stores information about what took place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">execution_count</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">error_before_exec</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">error_in_exec</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_before_exec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_in_exec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">raise_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reraises error if `success` is `False`, otherwise does nothing&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_before_exec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_before_exec</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_in_exec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_in_exec</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> object at </span><span class="si">%x</span><span class="s1">, execution_count=</span><span class="si">%s</span><span class="s1"> error_before_exec=</span><span class="si">%s</span><span class="s1"> error_in_exec=</span><span class="si">%s</span><span class="s1"> info=</span><span class="si">%s</span><span class="s1"> result=</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span>\
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_before_exec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_in_exec</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">InteractiveShell</span><span class="p">(</span><span class="n">SingletonConfigurable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An enhanced, interactive shell for Python.&quot;&quot;&quot;</span>

    <span class="n">_instance</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">ast_transformers</span> <span class="o">=</span> <span class="n">List</span><span class="p">([],</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of ast.NodeTransformer subclass instances, which will be applied</span>
<span class="sd">        to user input before code is run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">autocall</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make IPython automatically call any callable object even if you didn&#39;t</span>
<span class="sd">        type explicit parentheses. For example, &#39;str 43&#39; becomes &#39;str(43)&#39;</span>
<span class="sd">        automatically. The value can be &#39;0&#39; to disable the feature, &#39;1&#39; for</span>
<span class="sd">        &#39;smart&#39; autocall, where it is not applied if there are no more</span>
<span class="sd">        arguments on the line, and &#39;2&#39; for &#39;full&#39; autocall, where all callable</span>
<span class="sd">        objects are automatically called (even if no arguments are present).</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># TODO: remove all autoindent logic and put into frontends.</span>
    <span class="c1"># We can&#39;t do this yet because even runlines uses the autoindent.</span>
    <span class="n">autoindent</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Autoindent IPython code entered interactively.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">automagic</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable magic commands to be called without the leading %.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">banner1</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="n">default_banner</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The part of the banner to be printed before the profile&quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">banner2</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The part of the banner to be printed after the profile&quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">cache_size</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the size of the output cache.  The default is 1000, you can</span>
<span class="sd">        change it permanently in your config file.  Setting it to 0 completely</span>
<span class="sd">        disables the caching system, and the minimum value accepted is 3 (if</span>
<span class="sd">        you provide a value less than 3, it is reset to 0 and a warning is</span>
<span class="sd">        issued).  This limit is defined because otherwise you&#39;ll spend more</span>
<span class="sd">        time re-flushing a too small cache than working</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">color_info</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use colors for displaying information about objects. Because this</span>
<span class="sd">        information is passed through a pager (like &#39;less&#39;), and some pagers</span>
<span class="sd">        get confused with color codes, this capability can be turned off.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">CaselessStrEnum</span><span class="p">((</span><span class="s1">&#39;Neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;NoColor&#39;</span><span class="p">,</span><span class="s1">&#39;LightBG&#39;</span><span class="p">,</span><span class="s1">&#39;Linux&#39;</span><span class="p">),</span>
                             <span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;Neutral&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the color scheme (NoColor, Neutral, Linux, or LightBG).&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">disable_failing_post_execute</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Don&#39;t call post-execute functions that have failed in the past.&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">display_formatter</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">DisplayFormatter</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">displayhook_class</span> <span class="o">=</span> <span class="n">Type</span><span class="p">(</span><span class="n">DisplayHook</span><span class="p">)</span>
    <span class="n">display_pub_class</span> <span class="o">=</span> <span class="n">Type</span><span class="p">(</span><span class="n">DisplayPublisher</span><span class="p">)</span>
    
    <span class="n">sphinxify_docstring</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enables rich html representation of docstrings. (This requires the</span>
<span class="sd">        docrepr module).</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;sphinxify_docstring&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_sphinxify_docstring_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;`sphinxify_docstring` is provisional since IPython 5.0 and might change in future versions.&quot;</span> <span class="p">,</span> <span class="n">ProvisionalWarning</span><span class="p">)</span>

    <span class="n">enable_html_pager</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        (Provisional API) enables html representation in mime bundles sent</span>
<span class="sd">        to pagers.</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s2">&quot;enable_html_pager&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_enable_html_pager_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;`enable_html_pager` is provisional since IPython 5.0 and might change in future versions.&quot;</span><span class="p">,</span> <span class="n">ProvisionalWarning</span><span class="p">)</span>

    <span class="n">data_pub_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">exit_now</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">exiter</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">ExitAutocall</span><span class="p">)</span>
    <span class="nd">@default</span><span class="p">(</span><span class="s1">&#39;exiter&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_exiter_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ExitAutocall</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="c1"># Monotonically increasing execution counter</span>
    <span class="n">execution_count</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s2">&quot;&lt;ipython console&gt;&quot;</span><span class="p">)</span>
    <span class="n">ipython_dir</span><span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Set to get_ipython_dir() in __init__</span>

    <span class="c1"># Input splitter, to transform input line by line and detect when a block</span>
    <span class="c1"># is ready to be executed.</span>
    <span class="n">input_splitter</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.inputsplitter.IPythonInputSplitter&#39;</span><span class="p">,</span>
                              <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;line_input_checker&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

    <span class="c1"># This InputSplitter instance is used to transform completed cells before</span>
    <span class="c1"># running them. It allows cell magics to contain blank lines.</span>
    <span class="n">input_transformer_manager</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.inputsplitter.IPythonInputSplitter&#39;</span><span class="p">,</span>
                                         <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;line_input_checker&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

    <span class="n">logstart</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start logging to the default log file in overwrite mode.</span>
<span class="sd">        Use `logappend` to specify a log file to **append** logs to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The name of the logfile to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logappend</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start logging to the given file in append mode.</span>
<span class="sd">        Use `logfile` to specify a log file to **overwrite** logs to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">object_info_string_level</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pdb</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically call the pdb debugger after every exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">display_page</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;If True, anything that would be passed to the pager</span>
<span class="s2">        will be displayed as regular output instead.&quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># deprecated prompt traits:</span>
    
    <span class="n">prompt_in1</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;In [</span><span class="se">\\</span><span class="s1">#]: &#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Deprecated since IPython 4.0 and ignored since 5.0, set TerminalInteractiveShell.prompts object directly.&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">prompt_in2</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;   .</span><span class="se">\\</span><span class="s1">D.: &#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Deprecated since IPython 4.0 and ignored since 5.0, set TerminalInteractiveShell.prompts object directly.&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">prompt_out</span> <span class="o">=</span> <span class="n">Unicode</span><span class="p">(</span><span class="s1">&#39;Out[</span><span class="se">\\</span><span class="s1">#]: &#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Deprecated since IPython 4.0 and ignored since 5.0, set TerminalInteractiveShell.prompts object directly.&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">prompts_pad_left</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Deprecated since IPython 4.0 and ignored since 5.0, set TerminalInteractiveShell.prompts object directly.&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="nd">@observe</span><span class="p">(</span><span class="s1">&#39;prompt_in1&#39;</span><span class="p">,</span> <span class="s1">&#39;prompt_in2&#39;</span><span class="p">,</span> <span class="s1">&#39;prompt_out&#39;</span><span class="p">,</span> <span class="s1">&#39;prompt_pad_left&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_prompt_trait_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;InteractiveShell.</span><span class="si">{name}</span><span class="s2"> is deprecated since IPython 4.0&quot;</span>
             <span class="s2">&quot; and ignored since 5.0, set TerminalInteractiveShell.prompts&quot;</span>
             <span class="s2">&quot; object directly.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
        
        <span class="c1"># protect against weird cases where self.config may not exist:</span>

    <span class="n">show_rewritten_input</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show rewritten input, e.g. for autocall.&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">quiet</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">history_length</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Total length of command history&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">history_load_length</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The number of saved history entries to be loaded</span>
<span class="sd">        into the history buffer at startup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ast_node_interactivity</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">([</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="s1">&#39;last_expr&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;last_expr_or_assign&#39;</span><span class="p">],</span>
                                  <span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;last_expr&#39;</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &#39;all&#39;, &#39;last&#39;, &#39;last_expr&#39; or &#39;none&#39;, &#39;last_expr_or_assign&#39; specifying</span>
<span class="s2">        which nodes should be run interactively (displaying output from expressions).</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># TODO: this part of prompt management should be moved to the frontends.</span>
    <span class="c1"># Use custom TraitTypes that convert &#39;0&#39;-&gt;&#39;&#39; and &#39;\\n&#39;-&gt;&#39;\n&#39;</span>
    <span class="n">separate_in</span> <span class="o">=</span> <span class="n">SeparateUnicode</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">separate_out</span> <span class="o">=</span> <span class="n">SeparateUnicode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">separate_out2</span> <span class="o">=</span> <span class="n">SeparateUnicode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">wildcards_case_sensitive</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">xmode</span> <span class="o">=</span> <span class="n">CaselessStrEnum</span><span class="p">((</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span><span class="s1">&#39;Plain&#39;</span><span class="p">,</span> <span class="s1">&#39;Verbose&#39;</span><span class="p">),</span>
                            <span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Switch modes for the IPython exception handlers.&quot;</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Subcomponents of InteractiveShell</span>
    <span class="n">alias_manager</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.alias.AliasManager&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">prefilter_manager</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.prefilter.PrefilterManager&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">builtin_trap</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.builtin_trap.BuiltinTrap&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">display_trap</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.display_trap.DisplayTrap&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">extension_manager</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.extensions.ExtensionManager&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">payload_manager</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.payload.PayloadManager&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">history_manager</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.history.HistoryAccessorBase&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">magics_manager</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.magic.MagicsManager&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">profile_dir</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.application.ProfileDir&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_dir</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;profile_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>


    <span class="c1"># Private interface</span>
    <span class="n">_post_execute</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">()</span>

    <span class="c1"># Tracks any GUI loop loaded for pylab</span>
    <span class="n">pylab_gui_select</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">last_execution_succeeded</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Did last executed command succeeded&#39;</span><span class="p">)</span>

    <span class="n">last_execution_result</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="s1">&#39;IPython.core.interactiveshell.ExecutionResult&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Result of executing the last command&#39;</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipython_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">profile_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">user_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">custom_exceptions</span><span class="o">=</span><span class="p">((),</span> <span class="kc">None</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># This is where traits with a config_key argument are updated</span>
        <span class="c1"># from the values on config.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">InteractiveShell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;PromptManager&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;As of IPython 5.0 `PromptManager` config will have no effect&#39;</span>
                 <span class="s1">&#39; and has been replaced by TerminalInteractiveShell.prompts_class&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>

        <span class="c1"># These are relatively independent and stateless</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_ipython_dir</span><span class="p">(</span><span class="n">ipython_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_profile_dir</span><span class="p">(</span><span class="n">profile_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_instance_attrs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_environment</span><span class="p">()</span>
        
        <span class="c1"># Check if we&#39;re in a virtualenv, and set up sys.path.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_virtualenv</span><span class="p">()</span>

        <span class="c1"># Create namespaces (user_ns, user_global_ns, etc.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_create_namespaces</span><span class="p">(</span><span class="n">user_module</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>
        <span class="c1"># This has to be done after init_create_namespaces because it uses</span>
        <span class="c1"># something in self.user_ns, but before init_sys_modules, which</span>
        <span class="c1"># is the first thing to modify sys.</span>
        <span class="c1"># TODO: When we override sys.stdout and sys.stderr before this class</span>
        <span class="c1"># is created, we are saving the overridden ones here. Not sure if this</span>
        <span class="c1"># is what we want to do.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_sys_module_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_sys_modules</span><span class="p">()</span>

        <span class="c1"># While we&#39;re trying to have each part of the code directly access what</span>
        <span class="c1"># it needs without keeping redundant references to objects, we have too</span>
        <span class="c1"># much legacy code that expects ip.db to exist.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">PickleShareDB</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_dir</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_history</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_encoding</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_prefilter</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_syntax_highlighting</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_hooks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_events</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_pushd_popd_magic</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_user_ns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_builtins</span><span class="p">()</span>

        <span class="c1"># The following was in post_config_initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_inspector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_input_original</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_completer</span><span class="p">()</span>
        <span class="c1"># TODO: init_io() needs to happen before init_traceback handlers</span>
        <span class="c1"># because the traceback handlers hardcode the stdout/stderr streams.</span>
        <span class="c1"># This logic in in debugger.Pdb and should eventually be changed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_io</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_traceback_handlers</span><span class="p">(</span><span class="n">custom_exceptions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_prompts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_display_formatter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_display_pub</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_data_pub</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_displayhook</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_magics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_alias</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_logstart</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_pdb</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_extension_manager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_payload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_deprecation_warnings</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">late_startup_hook</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;shell_initialized&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atexit_operations</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ipython</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the currently running IPython instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Trait changed handlers</span>
    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="nd">@observe</span><span class="p">(</span><span class="s1">&#39;ipython_dir&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_ipython_dir_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change</span><span class="p">):</span>
        <span class="n">ensure_dir_exists</span><span class="p">(</span><span class="n">change</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">set_autoindent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the autoindent flag.</span>

<span class="sd">        If called with no arguments, it acts as a toggle.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autoindent</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoindent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autoindent</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># init_* methods called by __init__</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_ipython_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipython_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ipython_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ipython_dir</span> <span class="o">=</span> <span class="n">ipython_dir</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ipython_dir</span> <span class="o">=</span> <span class="n">get_ipython_dir</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_profile_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">profile_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profile_dir</span> <span class="o">=</span> <span class="n">profile_dir</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_dir</span> <span class="o">=</span>\
            <span class="n">ProfileDir</span><span class="o">.</span><span class="n">create_profile_dir_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ipython_dir</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_instance_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">more</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># command compiler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile</span> <span class="o">=</span> <span class="n">CachingCompiler</span><span class="p">()</span>

        <span class="c1"># Make an empty namespace, which extension writers can rely on both</span>
        <span class="c1"># existing and NEVER being used by ipython itself.  This gives them a</span>
        <span class="c1"># convenient location for storing additional information and state</span>
        <span class="c1"># their extensions may require, without fear of collisions with other</span>
        <span class="c1"># ipython names that may develop later.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">()</span>

        <span class="c1"># Temporary files used for various purposes.  Deleted at exit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempfiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdirs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># keep track of where we started running (mainly for crash post-mortem)</span>
        <span class="c1"># This is not being used anywhere currently.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starting_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="c1"># Indentation management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent_current_nsp</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Dict to track post-execution functions that have been registered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post_execute</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">init_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Any changes we need to make to the user&#39;s environment.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">init_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get system encoding at startup time.  Certain terminals (like Emacs</span>
        <span class="c1"># under Win32 have it set to None, and we need to have a known valid</span>
        <span class="c1"># encoding to use in the raw_input() method</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin_encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="s1">&#39;ascii&#39;</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdin_encoding</span> <span class="o">=</span> <span class="s1">&#39;ascii&#39;</span>


    <span class="nd">@observe</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">init_syntax_highlighting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Python source parser/formatter for syntax highlighting</span>
        <span class="n">pyformat</span> <span class="o">=</span> <span class="n">PyColorize</span><span class="o">.</span><span class="n">Parser</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pycolorize</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">src</span><span class="p">:</span> <span class="n">pyformat</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">refresh_style</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># No-op here, used in subclass</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">init_pushd_popd_magic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># for pushd/popd management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">home_dir</span> <span class="o">=</span> <span class="n">get_home_dir</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dir_stack</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">init_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home_dir</span><span class="p">,</span> <span class="n">logfname</span><span class="o">=</span><span class="s1">&#39;ipython_log.py&#39;</span><span class="p">,</span>
                             <span class="n">logmode</span><span class="o">=</span><span class="s1">&#39;rotate&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_logstart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize logging in case it was requested at the command line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logappend</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magic</span><span class="p">(</span><span class="s1">&#39;logstart </span><span class="si">%s</span><span class="s1"> append&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">logappend</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magic</span><span class="p">(</span><span class="s1">&#39;logstart </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">logstart</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magic</span><span class="p">(</span><span class="s1">&#39;logstart&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_deprecation_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        register default filter for deprecation warning.</span>

<span class="sd">        This will allow deprecation warning of function used interactively to show</span>
<span class="sd">        warning to users, and still hide deprecation warning from libraries import.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__name__&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">init_builtins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># A single, static flag that we set to True.  Its presence indicates</span>
        <span class="c1"># that an IPython shell has been created, and we make no attempts at</span>
        <span class="c1"># removing on exit or representing the existence of more than one</span>
        <span class="c1"># IPython at a time.</span>
        <span class="n">builtin_mod</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;__IPYTHON__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">builtin_mod</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;display&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">display</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span> <span class="o">=</span> <span class="n">BuiltinTrap</span><span class="p">(</span><span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@observe</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">init_inspector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Object inspector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inspector</span> <span class="o">=</span> <span class="n">oinspect</span><span class="o">.</span><span class="n">Inspector</span><span class="p">(</span><span class="n">oinspect</span><span class="o">.</span><span class="n">InspectColors</span><span class="p">,</span>
                                            <span class="n">PyColorize</span><span class="o">.</span><span class="n">ANSICodeColors</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">object_info_string_level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_io</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This will just use sys.stdout and sys.stderr. If you want to</span>
        <span class="c1"># override sys.stdout and sys.stderr themselves, you need to do that</span>
        <span class="c1"># *before* instantiating this class, because io holds onto</span>
        <span class="c1"># references to the underlying streams.</span>
        <span class="c1"># io.std* are deprecated, but don&#39;t show our own deprecation warnings</span>
        <span class="c1"># during initialization of the deprecated API.</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">IOStream</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">IOStream</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_prompts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Set system prompts, so that scripts can decide if they are running</span>
        <span class="c1"># interactively.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">ps1</span> <span class="o">=</span> <span class="s1">&#39;In : &#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">ps2</span> <span class="o">=</span> <span class="s1">&#39;...: &#39;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">ps3</span> <span class="o">=</span> <span class="s1">&#39;Out: &#39;</span>

    <span class="k">def</span> <span class="nf">init_display_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_formatter</span> <span class="o">=</span> <span class="n">DisplayFormatter</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_formatter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_display_pub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_pub_class</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_pub</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_data_pub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_pub_class</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_pub</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_pub_class</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_pub</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_displayhook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initialize displayhook, set in/out prompts and printing system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayhook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayhook_class</span><span class="p">(</span>
            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">cache_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayhook</span><span class="p">)</span>
        <span class="c1"># This is a context manager that installs/revmoes the displayhook at</span>
        <span class="c1"># the appropriate time.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_trap</span> <span class="o">=</span> <span class="n">DisplayTrap</span><span class="p">(</span><span class="n">hook</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">displayhook</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_virtualenv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a virtualenv to sys.path so the user can import modules from it.</span>
<span class="sd">        This isn&#39;t perfect: it doesn&#39;t use the Python interpreter with which the</span>
<span class="sd">        virtualenv was built, and it ignores the --no-site-packages option. A</span>
<span class="sd">        warning will appear suggesting the user installs IPython in the</span>
<span class="sd">        virtualenv, but for many cases, it probably works well enough.</span>
<span class="sd">        </span>
<span class="sd">        Adapted from code snippets online.</span>
<span class="sd">        </span>
<span class="sd">        http://blog.ufsoft.org/2009/1/29/ipython-and-virtualenv</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;VIRTUAL_ENV&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="c1"># Not in a virtualenv</span>
            <span class="k">return</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">p_venv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;VIRTUAL_ENV&#39;</span><span class="p">])</span>

        <span class="c1"># executable path should end like /bin/python or \\scripts\\python.exe</span>
        <span class="n">p_exe_up2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">p_exe_up2</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">p_exe_up2</span><span class="p">,</span> <span class="n">p_venv</span><span class="p">):</span>
            <span class="c1"># Our exe is inside the virtualenv, don&#39;t need to do anything.</span>
            <span class="k">return</span>

        <span class="c1"># fallback venv detection:</span>
        <span class="c1"># stdlib venv may symlink sys.executable, so we can&#39;t use realpath.</span>
        <span class="c1"># but others can symlink *to* the venv Python, so we can&#39;t just use sys.executable.</span>
        <span class="c1"># So we just check every item in the symlink tree (generally &lt;= 3)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        
        <span class="c1"># In Cygwin paths like &quot;c:\...&quot; and &#39;\cygdrive\c\...&#39; are possible</span>
        <span class="k">if</span> <span class="n">p_venv</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cygdrive&#39;</span><span class="p">):</span>
            <span class="n">p_venv</span> <span class="o">=</span> <span class="n">p_venv</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_venv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">p_venv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span>
            <span class="n">p_venv</span> <span class="o">=</span> <span class="n">p_venv</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">p_venv</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">):</span>
            <span class="c1"># Running properly in the virtualenv, don&#39;t need to do anything</span>
            <span class="k">return</span>
        
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Attempting to work in a virtualenv. If you encounter problems, please &quot;</span>
             <span class="s2">&quot;install IPython inside the virtualenv.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
            <span class="n">virtual_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;VIRTUAL_ENV&#39;</span><span class="p">],</span> <span class="s1">&#39;Lib&#39;</span><span class="p">,</span> <span class="s1">&#39;site-packages&#39;</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">virtual_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;VIRTUAL_ENV&#39;</span><span class="p">],</span> <span class="s1">&#39;lib&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;python</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;site-packages&#39;</span><span class="p">)</span>
        
        <span class="kn">import</span> <span class="nn">site</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">virtual_env</span><span class="p">)</span>
        <span class="n">site</span><span class="o">.</span><span class="n">addsitedir</span><span class="p">(</span><span class="n">virtual_env</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to injections into the sys module</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">save_sys_module_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the state of hooks in the sys module.</span>

<span class="sd">        This has to be called after self.user_module is created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_sys_module_state</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stdin&#39;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span>
                                       <span class="s1">&#39;stdout&#39;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                                       <span class="s1">&#39;stderr&#39;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                                       <span class="s1">&#39;excepthook&#39;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_sys_modules_main_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_module</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_sys_modules_main_mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restore_sys_module_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restore the state of the sys module.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_sys_module_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Reset what what done in self.init_sys_modules</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_sys_modules_main_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_orig_sys_modules_main_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_sys_modules_main_mod</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to the banner</span>
    <span class="c1">#-------------------------------------------------------------------------</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">banner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">banner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">banner1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">!=</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">banner</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">IPython profile: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">banner2</span><span class="p">:</span>
            <span class="n">banner</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">banner2</span>
        <span class="k">return</span> <span class="n">banner</span>

    <span class="k">def</span> <span class="nf">show_banner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">banner</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">banner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">banner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">banner</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">banner</span><span class="p">)</span>
    
    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to hooks</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># hooks holds pointers used for user-side customizations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">Struct</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">strdispatchers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Set all default hooks, defined in the IPython.hooks module.</span>
        <span class="n">hooks</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hooks</span>
        <span class="k">for</span> <span class="n">hook_name</span> <span class="ow">in</span> <span class="n">hooks</span><span class="o">.</span><span class="n">__all__</span><span class="p">:</span>
            <span class="c1"># default hooks have priority 100, i.e. low; user hooks should have</span>
            <span class="c1"># 0-100 priority</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_hook</span><span class="p">(</span><span class="n">hook_name</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">hooks</span><span class="p">,</span><span class="n">hook_name</span><span class="p">),</span> <span class="mi">100</span><span class="p">,</span> <span class="n">_warn_deprecated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_page</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_hook</span><span class="p">(</span><span class="s1">&#39;show_in_pager&#39;</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">as_hook</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">display_page</span><span class="p">),</span> <span class="mi">90</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">hook</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">str_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">re_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">_warn_deprecated</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set_hook(name,hook) -&gt; sets an internal IPython hook.</span>

<span class="sd">        IPython exposes some of its internal API as user-modifiable hooks.  By</span>
<span class="sd">        adding your function to one of these hooks, you can modify IPython&#39;s</span>
<span class="sd">        behavior to call at runtime your own routines.&quot;&quot;&quot;</span>

        <span class="c1"># At some point in the future, this should validate the hook before it</span>
        <span class="c1"># accepts it.  Probably at least check that the hook takes the number</span>
        <span class="c1"># of args it&#39;s supposed to.</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># check if the hook is for strdispatcher first</span>
        <span class="k">if</span> <span class="n">str_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strdispatchers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">StrDispatch</span><span class="p">())</span>
            <span class="n">sdp</span><span class="o">.</span><span class="n">add_s</span><span class="p">(</span><span class="n">str_key</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">priority</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strdispatchers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdp</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">re_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strdispatchers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">StrDispatch</span><span class="p">())</span>
            <span class="n">sdp</span><span class="o">.</span><span class="n">add_re</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">re_key</span><span class="p">),</span> <span class="n">f</span><span class="p">,</span> <span class="n">priority</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strdispatchers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdp</span>
            <span class="k">return</span>

        <span class="n">dp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IPython</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">__all__</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning! Hook &#39;</span><span class="si">%s</span><span class="s2">&#39; is not one of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                  <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">IPython</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">__all__</span> <span class="p">))</span>

        <span class="k">if</span> <span class="n">_warn_deprecated</span> <span class="ow">and</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">IPython</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">deprecated</span><span class="p">):</span>
            <span class="n">alternative</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">deprecated</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Hook </span><span class="si">{}</span><span class="s2"> is deprecated. Use </span><span class="si">{}</span><span class="s2"> instead.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">alternative</span><span class="p">),</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dp</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">CommandChainDispatcher</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">priority</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># it was not commandchain, plain old func - replace</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">f</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to events</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EventManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">available_events</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;pre_execute&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clear_warning_registry</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_post_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DEPRECATED: Use ip.events.register(&#39;post_run_cell&#39;, func)</span>
<span class="sd">        </span>
<span class="sd">        Register a function for calling after code execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;ip.register_post_execute is deprecated, use &quot;</span>
             <span class="s2">&quot;ip.events.register(&#39;post_run_cell&#39;, func) instead.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;post_run_cell&#39;</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_clear_warning_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># clear the warning registry, so that different code blocks with</span>
        <span class="c1"># overlapping line number ranges don&#39;t cause spurious suppression of</span>
        <span class="c1"># warnings (see gh-6611 for details)</span>
        <span class="k">if</span> <span class="s2">&quot;__warningregistry__&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">[</span><span class="s2">&quot;__warningregistry__&quot;</span><span class="p">]</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to the &quot;main&quot; module</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">new_main_mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">modname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new &#39;main&#39; module object for user code execution.</span>
<span class="sd">        </span>
<span class="sd">        ``filename`` should be the path of the script which will be run in the</span>
<span class="sd">        module. Requests with the same filename will get the same module, with</span>
<span class="sd">        its namespace cleared.</span>
<span class="sd">        </span>
<span class="sd">        ``modname`` should be the module name - normally either &#39;__main__&#39; or</span>
<span class="sd">        the basename of the file without the extension.</span>
<span class="sd">        </span>
<span class="sd">        When scripts are executed via %run, we must keep a reference to their</span>
<span class="sd">        __main__ module around so that Python doesn&#39;t</span>
<span class="sd">        clear it, rendering references to module globals useless.</span>

<span class="sd">        This method keeps said reference in a private dict, keyed by the</span>
<span class="sd">        absolute path of the script. This way, for multiple executions of the</span>
<span class="sd">        same script we only keep one copy of the namespace (the last one),</span>
<span class="sd">        thus preventing memory leaks from old references while allowing the</span>
<span class="sd">        objects from the last execution to be accessible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">main_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_mod_cache</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">main_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_mod_cache</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span>
                        <span class="n">modname</span><span class="p">,</span>
                        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Module created for script run in IPython&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">main_mod</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">main_mod</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">modname</span>
        
        <span class="n">main_mod</span><span class="o">.</span><span class="vm">__file__</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c1"># It seems pydoc (and perhaps others) needs any module instance to</span>
        <span class="c1"># implement a __nonzero__ method</span>
        <span class="n">main_mod</span><span class="o">.</span><span class="n">__nonzero__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="n">main_mod</span>

    <span class="k">def</span> <span class="nf">clear_main_mod_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the cache of main modules.</span>

<span class="sd">        Mainly for use by utilities like %reset.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        In [15]: import IPython</span>

<span class="sd">        In [16]: m = _ip.new_main_mod(IPython.__file__, &#39;IPython&#39;)</span>

<span class="sd">        In [17]: len(_ip._main_mod_cache) &gt; 0</span>
<span class="sd">        Out[17]: True</span>

<span class="sd">        In [18]: _ip.clear_main_mod_cache()</span>

<span class="sd">        In [19]: len(_ip._main_mod_cache) == 0</span>
<span class="sd">        Out[19]: True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_mod_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to debugging</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Set calling of pdb on exceptions</span>
        <span class="c1"># self.call_pdb is a property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_pdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span>

    <span class="k">def</span> <span class="nf">_get_call_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_pdb</span>

    <span class="k">def</span> <span class="nf">_set_call_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;new call_pdb value must be boolean&#39;</span><span class="p">)</span>

        <span class="c1"># store value in instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_call_pdb</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c1"># notify the actual exception handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">call_pdb</span> <span class="o">=</span> <span class="n">val</span>

    <span class="n">call_pdb</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_call_pdb</span><span class="p">,</span><span class="n">_set_call_pdb</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;Control auto-activation of pdb at exceptions&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">debugger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call the pdb debugger.</span>

<span class="sd">        Keywords:</span>

<span class="sd">          - force(False): by default, this routine checks the instance call_pdb</span>
<span class="sd">            flag and does not actually invoke the debugger if the flag is false.</span>
<span class="sd">            The &#39;force&#39; option forces the debugger to activate even if the flag</span>
<span class="sd">            is false.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">force</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_pdb</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="s1">&#39;last_traceback&#39;</span><span class="p">):</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;No traceback has been produced, nothing to debug.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to IPython&#39;s various namespaces</span>
    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="n">default_user_namespaces</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">init_create_namespaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_ns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Create the namespace where the user will operate.  user_ns is</span>
        <span class="c1"># normally the only one used, and it is passed to the exec calls as</span>
        <span class="c1"># the locals argument.  But we do carry a user_global_ns namespace</span>
        <span class="c1"># given as the exec &#39;globals&#39; argument,  This is useful in embedding</span>
        <span class="c1"># situations where the ipython shell opens in a context where the</span>
        <span class="c1"># distinction between locals and globals is meaningful.  For</span>
        <span class="c1"># non-embedded contexts, it is just the same object as the user_ns dict.</span>

        <span class="c1"># FIXME. For some strange reason, __builtins__ is showing up at user</span>
        <span class="c1"># level as a dict instead of a module. This is a manual fix, but I</span>
        <span class="c1"># should really track down where the problem is coming from. Alex</span>
        <span class="c1"># Schmolck reported this problem first.</span>

        <span class="c1"># A useful post by Alex Martelli on this topic:</span>
        <span class="c1"># Re: inconsistent value from __builtins__</span>
        <span class="c1"># Von: Alex Martelli &lt;aleaxit@yahoo.com&gt;</span>
        <span class="c1"># Datum: Freitag 01 Oktober 2004 04:45:34 nachmittags/abends</span>
        <span class="c1"># Gruppen: comp.lang.python</span>

        <span class="c1"># Michael Hohn &lt;hohn@hooknose.lbl.gov&gt; wrote:</span>
        <span class="c1"># &gt; &gt;&gt;&gt; print type(builtin_check.get_global_binding(&#39;__builtins__&#39;))</span>
        <span class="c1"># &gt; &lt;type &#39;dict&#39;&gt;</span>
        <span class="c1"># &gt; &gt;&gt;&gt; print type(__builtins__)</span>
        <span class="c1"># &gt; &lt;type &#39;module&#39;&gt;</span>
        <span class="c1"># &gt; Is this difference in return value intentional?</span>

        <span class="c1"># Well, it&#39;s documented that &#39;__builtins__&#39; can be either a dictionary</span>
        <span class="c1"># or a module, and it&#39;s been that way for a long time. Whether it&#39;s</span>
        <span class="c1"># intentional (or sensible), I don&#39;t know. In any case, the idea is</span>
        <span class="c1"># that if you need to access the built-in namespace directly, you</span>
        <span class="c1"># should start with &quot;import __builtin__&quot; (note, no &#39;s&#39;) which will</span>
        <span class="c1"># definitely give you a module. Yeah, it&#39;s somewhat confusing:-(.</span>

        <span class="c1"># These routines return a properly built module and dict as needed by</span>
        <span class="c1"># the rest of the code, and can also be used by extension writers to</span>
        <span class="c1"># generate properly initialized namespaces.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">user_ns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">user_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_user_namespaces</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_user_module</span><span class="p">(</span><span class="n">user_module</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">)</span>

        <span class="c1"># A record of hidden variables we have added to the user namespace, so</span>
        <span class="c1"># we can list later only variables defined in actual interactive use.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns_hidden</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Now that FakeModule produces a real module, we&#39;ve run into a nasty</span>
        <span class="c1"># problem: after script execution (via %run), the module where the user</span>
        <span class="c1"># code ran is deleted.  Now that this object is a true module (needed</span>
        <span class="c1"># so doctest and other tools work correctly), the Python module</span>
        <span class="c1"># teardown mechanism runs over it, and sets to None every variable</span>
        <span class="c1"># present in that module.  Top-level references to objects from the</span>
        <span class="c1"># script survive, because the user_ns is updated with them.  However,</span>
        <span class="c1"># calling functions defined in the script that use other things from</span>
        <span class="c1"># the script will fail, because the function&#39;s closure had references</span>
        <span class="c1"># to the original objects, which are now all None.  So we must protect</span>
        <span class="c1"># these modules from deletion by keeping a cache.</span>
        <span class="c1">#</span>
        <span class="c1"># To avoid keeping stale modules around (we only need the one from the</span>
        <span class="c1"># last run), we use a dict keyed with the full path to the script, so</span>
        <span class="c1"># only the last version of the module is held in the cache.  Note,</span>
        <span class="c1"># however, that we must cache the module *namespace contents* (their</span>
        <span class="c1"># __dict__).  Because if we try to cache the actual modules, old ones</span>
        <span class="c1"># (uncached) could be destroyed while still holding references (such as</span>
        <span class="c1"># those held by GUI objects that tend to be long-lived)&gt;</span>
        <span class="c1">#</span>
        <span class="c1"># The %reset command will flush this cache.  See the cache_main_mod()</span>
        <span class="c1"># and clear_main_mod_cache() methods for details on use.</span>

        <span class="c1"># This is the cache used for &#39;main&#39; namespaces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_main_mod_cache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># A table holding all the namespaces IPython deals with, so that</span>
        <span class="c1"># introspection facilities can search easily.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ns_table</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;user_global&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">user_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span>
                         <span class="s1">&#39;user_local&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">,</span>
                         <span class="s1">&#39;builtin&#39;</span><span class="p">:</span><span class="n">builtin_mod</span><span class="o">.</span><span class="vm">__dict__</span>
                         <span class="p">}</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_global_ns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_module</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span> <span class="nf">prepare_user_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_ns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare the module and namespace in which user code will be run.</span>
<span class="sd">        </span>
<span class="sd">        When IPython is started normally, both parameters are None: a new module</span>
<span class="sd">        is created automatically, and its __dict__ used as the namespace.</span>
<span class="sd">        </span>
<span class="sd">        If only user_module is provided, its __dict__ is used as the namespace.</span>
<span class="sd">        If only user_ns is provided, a dummy module is created, and user_ns</span>
<span class="sd">        becomes the global namespace. If both are provided (as they may be</span>
<span class="sd">        when embedding), user_ns is the local namespace, and user_module</span>
<span class="sd">        provides the global namespace.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user_module : module, optional</span>
<span class="sd">            The current user module in which IPython is being run. If None,</span>
<span class="sd">            a clean module will be created.</span>
<span class="sd">        user_ns : dict, optional</span>
<span class="sd">            A namespace in which to run interactive commands.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A tuple of user_module and user_ns, each properly initialised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_module</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user_ns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user_ns</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;__main__&quot;</span><span class="p">)</span>
            <span class="n">user_module</span> <span class="o">=</span> <span class="n">DummyMod</span><span class="p">()</span>
            <span class="n">user_module</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">user_ns</span>
            
        <span class="k">if</span> <span class="n">user_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user_module</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="s2">&quot;__main__&quot;</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Automatically created module for IPython interactive environment&quot;</span><span class="p">)</span>
        
        <span class="c1"># We must ensure that __builtin__ (without the final &#39;s&#39;) is always</span>
        <span class="c1"># available and pointing to the __builtin__ *module*.  For more details:</span>
        <span class="c1"># http://mail.python.org/pipermail/python-dev/2001-April/014068.html</span>
        <span class="n">user_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;__builtin__&#39;</span><span class="p">,</span> <span class="n">builtin_mod</span><span class="p">)</span>
        <span class="n">user_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">,</span> <span class="n">builtin_mod</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">user_ns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user_ns</span> <span class="o">=</span> <span class="n">user_module</span><span class="o">.</span><span class="vm">__dict__</span>

        <span class="k">return</span> <span class="n">user_module</span><span class="p">,</span> <span class="n">user_ns</span>

    <span class="k">def</span> <span class="nf">init_sys_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We need to insert into sys.modules something that looks like a</span>
        <span class="c1"># module but which accesses the IPython namespace, for shelve and</span>
        <span class="c1"># pickle to work interactively. Normally they rely on getting</span>
        <span class="c1"># everything out of __main__, but for embedding purposes each IPython</span>
        <span class="c1"># instance has its own private namespace, so we can&#39;t go shoving</span>
        <span class="c1"># everything into __main__.</span>

        <span class="c1"># note, however, that we should only do this for non-embedded</span>
        <span class="c1"># ipythons, which really mimic the __main__.__dict__ with their own</span>
        <span class="c1"># namespace.  Embedded instances, on the other hand, should not do</span>
        <span class="c1"># this because they need to manage the user local/global namespaces</span>
        <span class="c1"># only, but they live within a &#39;normal&#39; __main__ (meaning, they</span>
        <span class="c1"># shouldn&#39;t overtake the execution environment of the script they&#39;re</span>
        <span class="c1"># embedded in).</span>

        <span class="c1"># This is overridden in the InteractiveShellEmbed subclass to a no-op.</span>
        <span class="n">main_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_module</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">main_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_module</span>

    <span class="k">def</span> <span class="nf">init_user_ns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize all user-visible namespaces to their minimum defaults.</span>

<span class="sd">        Certain history lists are also initialized here, as they effectively</span>
<span class="sd">        act as user namespaces.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        All data structures here are only filled in, they are NOT reset by this</span>
<span class="sd">        method.  If they were not empty before, data will simply be added to</span>
<span class="sd">        them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This function works in two parts: first we put a few things in</span>
        <span class="c1"># user_ns, and we sync that contents into user_ns_hidden so that these</span>
        <span class="c1"># initial variables aren&#39;t shown by %who.  After the sync, we add the</span>
        <span class="c1"># rest of what we *do* want the user to see with %who even on a new</span>
        <span class="c1"># session (probably nothing, so they really only see their own stuff)</span>

        <span class="c1"># The user dict must *always* have a __builtin__ reference to the</span>
        <span class="c1"># Python standard __builtin__ namespace,  which must be imported.</span>
        <span class="c1"># This is so that certain operations in prompt evaluation can be</span>
        <span class="c1"># reliably executed with builtins.  Note that we can NOT use</span>
        <span class="c1"># __builtins__ (note the &#39;s&#39;),  because that can either be a dict or a</span>
        <span class="c1"># module, and can even mutate at runtime, depending on the context</span>
        <span class="c1"># (Python makes no guarantees on it).  In contrast, __builtin__ is</span>
        <span class="c1"># always a module object, though it must be explicitly imported.</span>

        <span class="c1"># For more details:</span>
        <span class="c1"># http://mail.python.org/pipermail/python-dev/2001-April/014068.html</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># make global variables for user access to the histories</span>
        <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;_ih&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">input_hist_parsed</span>
        <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;_oh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">output_hist</span>
        <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;_dh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">dir_hist</span>

        <span class="c1"># user aliases to input and output histories.  These shouldn&#39;t show up</span>
        <span class="c1"># in %who, as they can have very large reprs.</span>
        <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;In&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">input_hist_parsed</span>
        <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;Out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">output_hist</span>

        <span class="c1"># Store myself as the public api!!!</span>
        <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;get_ipython&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ipython</span>
        
        <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exiter</span>
        <span class="n">ns</span><span class="p">[</span><span class="s1">&#39;quit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exiter</span>

        <span class="c1"># Sync what we&#39;ve added so far to user_ns_hidden so these aren&#39;t seen</span>
        <span class="c1"># by %who</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns_hidden</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>

        <span class="c1"># Anything put into ns now would show up in %who.  Think twice before</span>
        <span class="c1"># putting anything here, as we really want %who to show the user their</span>
        <span class="c1"># stuff, not our variables.</span>

        <span class="c1"># Finally, update the real user&#39;s namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_ns_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of references to all the namespace dictionaries in which</span>
<span class="sd">        IPython might store a user-created object.</span>
<span class="sd">        </span>
<span class="sd">        Note that this does not include the displayhook, which also caches</span>
<span class="sd">        objects from the output.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns_hidden</span><span class="p">]</span> <span class="o">+</span> \
               <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_main_mod_cache</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_session</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear all internal namespaces, and attempt to release references to</span>
<span class="sd">        user objects.</span>

<span class="sd">        If new_session is True, a new history session will be opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clear histories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">new_session</span><span class="p">)</span>
        <span class="c1"># Reset counter used to index all histories</span>
        <span class="k">if</span> <span class="n">new_session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execution_count</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Reset last execution result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_execution_succeeded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_execution_result</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Flush cached output items</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayhook</span><span class="o">.</span><span class="n">do_full_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">displayhook</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># The main execution namespaces must be cleared very carefully,</span>
        <span class="c1"># skipping the deletion of the builtin-related keys, because doing so</span>
        <span class="c1"># would cause errors in many object&#39;s __del__ methods.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span>
        <span class="n">drop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">drop_keys</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="s1">&#39;__builtin__&#39;</span><span class="p">)</span>
        <span class="n">drop_keys</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">)</span>
        <span class="n">drop_keys</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="s1">&#39;__name__&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">drop_keys</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">ns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns_hidden</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        
        <span class="c1"># Restore the user namespaces to minimal usability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_user_ns</span><span class="p">()</span>

        <span class="c1"># Restore the default and user aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_manager</span><span class="o">.</span><span class="n">clear_aliases</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_manager</span><span class="o">.</span><span class="n">init_aliases</span><span class="p">()</span>

        <span class="c1"># Flush the private list of module references kept for script</span>
        <span class="c1"># execution protection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_main_mod_cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">del_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">by_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a variable from the various namespaces, so that, as</span>
<span class="sd">        far as possible, we&#39;re not keeping any hidden references to it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        varname : str</span>
<span class="sd">            The name of the variable to delete.</span>
<span class="sd">        by_name : bool</span>
<span class="sd">            If True, delete variables with the given name in each</span>
<span class="sd">            namespace. If False (default), find the variable in the user</span>
<span class="sd">            namespace, and delete references to it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;__builtin__&#39;</span><span class="p">,</span> <span class="s1">&#39;__builtins__&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Refusing to delete </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">varname</span><span class="p">)</span>

        <span class="n">ns_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ns_refs</span>
        
        <span class="k">if</span> <span class="n">by_name</span><span class="p">:</span>                    <span class="c1"># Delete by name</span>
            <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">ns_refs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">ns</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>                         <span class="c1"># Delete by object</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;name &#39;</span><span class="si">%s</span><span class="s2">&#39; is not defined&quot;</span> <span class="o">%</span> <span class="n">varname</span><span class="p">)</span>
            <span class="c1"># Also check in output history</span>
            <span class="n">ns_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">output_hist</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">ns_refs</span><span class="p">:</span>
                <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ns</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">ns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="c1"># Ensure it is removed from the last execution result</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_execution_result</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_execution_result</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># displayhook keeps extra references, but not in a dictionary</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;__&#39;</span><span class="p">,</span> <span class="s1">&#39;___&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayhook</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displayhook</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset_selective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear selective variables from internal namespaces based on a</span>
<span class="sd">        specified regular expression.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        regex : string or compiled pattern, optional</span>
<span class="sd">            A regular expression pattern that will be used in searching</span>
<span class="sd">            variable names in the users namespaces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">regex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;regex must be a string or compiled pattern&#39;</span><span class="p">)</span>
            <span class="c1"># Search for keys in each namespace that match the given regex</span>
            <span class="c1"># If a match is found, delete the key/value pair.</span>
            <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ns_refs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">ns</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inject a group of variables into the IPython user namespace.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        variables : dict, str or list/tuple of str</span>
<span class="sd">            The variables to inject into the user&#39;s namespace.  If a dict, a</span>
<span class="sd">            simple update is done.  If a str, the string is assumed to have</span>
<span class="sd">            variable names separated by spaces.  A list/tuple of str can also</span>
<span class="sd">            be used to give the variable names.  If just the variable names are</span>
<span class="sd">            give (list/tuple/str) then the variable values looked up in the</span>
<span class="sd">            callers frame.</span>
<span class="sd">        interactive : bool</span>
<span class="sd">            If True (default), the variables will be listed with the ``who``</span>
<span class="sd">            magic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vdict</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># We need a dict of name/value pairs to do namespace updates.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">vdict</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">vlist</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vlist</span> <span class="o">=</span> <span class="n">variables</span>
            <span class="n">vdict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cf</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vlist</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vdict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cf</span><span class="o">.</span><span class="n">f_globals</span><span class="p">,</span> <span class="n">cf</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not get variable </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">cf</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;variables must be a dict/str/list/tuple&#39;</span><span class="p">)</span>

        <span class="c1"># Propagate variables to user namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vdict</span><span class="p">)</span>

        <span class="c1"># And configure interactive visibility</span>
        <span class="n">user_ns_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns_hidden</span>
        <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vdict</span><span class="p">:</span>
                <span class="n">user_ns_hidden</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user_ns_hidden</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vdict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a dict of variables from the user namespace, if they are the</span>
<span class="sd">        same as the values in the dictionary.</span>
<span class="sd">        </span>
<span class="sd">        This is intended for use by extensions: variables that they&#39;ve added can</span>
<span class="sd">        be taken back out if they are unloaded, without removing any that the</span>
<span class="sd">        user has overwritten.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        variables : dict</span>
<span class="sd">          A dictionary mapping object names (as strings) to the objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_ns_hidden</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to object introspection</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_ofind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oname</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find an object in the available namespaces.</span>

<span class="sd">        self._ofind(oname) -&gt; dict with keys: found,obj,ospace,ismagic</span>

<span class="sd">        Has special code to detect magic functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">oname</span> <span class="o">=</span> <span class="n">oname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">oname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ESC_MAGIC</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="n">oname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ESC_MAGIC2</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">oname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;found&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">namespaces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Namespaces to search in:</span>
            <span class="c1"># Put them in a list. The order is important so that we</span>
            <span class="c1"># find things in the same order that Python finds them.</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;Interactive&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">),</span>
                           <span class="p">(</span><span class="s1">&#39;Interactive (global)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">),</span>
                           <span class="p">(</span><span class="s1">&#39;Python builtin&#39;</span><span class="p">,</span> <span class="n">builtin_mod</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">),</span>
                           <span class="p">]</span>

        <span class="n">ismagic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">isalias</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ospace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Look for the given name by splitting it in parts.  If the head is</span>
        <span class="c1"># found, then we look for all the remaining parts as members, and only</span>
        <span class="c1"># declare success if we can find them all.</span>
        <span class="n">oname_parts</span> <span class="o">=</span> <span class="n">oname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">oname_head</span><span class="p">,</span> <span class="n">oname_rest</span> <span class="o">=</span> <span class="n">oname_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">oname_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">nsname</span><span class="p">,</span><span class="n">ns</span> <span class="ow">in</span> <span class="n">namespaces</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="n">oname_head</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">oname_rest</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">parent</span> <span class="o">=</span> <span class="n">obj</span>
                        <span class="c1"># The last part is looked up in a special way to avoid</span>
                        <span class="c1"># descriptor invocation as it may raise or have side</span>
                        <span class="c1"># effects.</span>
                        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">oname_rest</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattr_property</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="c1"># Blanket except b/c some badly implemented objects</span>
                        <span class="c1"># allow __getattr__ to raise exceptions other than</span>
                        <span class="c1"># AttributeError, which then crashes IPython.</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If we finish the for loop (no break), we got all members</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">ospace</span> <span class="o">=</span> <span class="n">nsname</span>
                    <span class="k">break</span>  <span class="c1"># namespace loop</span>

        <span class="c1"># Try to see if it&#39;s magic</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">oname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ESC_MAGIC2</span><span class="p">):</span>
                <span class="n">oname</span> <span class="o">=</span> <span class="n">oname</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">ESC_MAGIC2</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_cell_magic</span><span class="p">(</span><span class="n">oname</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">oname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ESC_MAGIC</span><span class="p">):</span>
                <span class="n">oname</span> <span class="o">=</span> <span class="n">oname</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">ESC_MAGIC</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="n">oname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># search without prefix, so run? will find %run?</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="n">oname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_cell_magic</span><span class="p">(</span><span class="n">oname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ospace</span> <span class="o">=</span> <span class="s1">&#39;IPython internal&#39;</span>
                <span class="n">ismagic</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">isalias</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Alias</span><span class="p">)</span>

        <span class="c1"># Last try: special-case some literals like &#39;&#39;, [], {}, etc:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">oname_head</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;[]&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;()&#39;</span><span class="p">]:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">oname_head</span><span class="p">)</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ospace</span> <span class="o">=</span> <span class="s1">&#39;Interactive&#39;</span>

        <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;obj&#39;</span><span class="p">:</span><span class="n">obj</span><span class="p">,</span>
                <span class="s1">&#39;found&#39;</span><span class="p">:</span><span class="n">found</span><span class="p">,</span>
                <span class="s1">&#39;parent&#39;</span><span class="p">:</span><span class="n">parent</span><span class="p">,</span>
                <span class="s1">&#39;ismagic&#39;</span><span class="p">:</span><span class="n">ismagic</span><span class="p">,</span>
                <span class="s1">&#39;isalias&#39;</span><span class="p">:</span><span class="n">isalias</span><span class="p">,</span>
                <span class="s1">&#39;namespace&#39;</span><span class="p">:</span><span class="n">ospace</span>
               <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_getattr_property</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Property-aware getattr to use in object finding.</span>

<span class="sd">        If attrname represents a property, return it unevaluated (in case it has</span>
<span class="sd">        side effects or raises an error.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># `getattr(type(obj), attrname)` is not guaranteed to return</span>
                <span class="c1"># `obj`, but does so for property:</span>
                <span class="c1">#</span>
                <span class="c1"># property.__get__(self, None, cls) -&gt; self</span>
                <span class="c1">#</span>
                <span class="c1"># The universal alternative is to traverse the mro manually</span>
                <span class="c1"># searching for attrname in class dicts.</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">attrname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This relies on the fact that data descriptors (with both</span>
                <span class="c1"># __get__ &amp; __set__ magic methods) take precedence over</span>
                <span class="c1"># instance-level attributes:</span>
                <span class="c1">#</span>
                <span class="c1">#    class A(object):</span>
                <span class="c1">#        @property</span>
                <span class="c1">#        def foobar(self): return 123</span>
                <span class="c1">#    a = A()</span>
                <span class="c1">#    a.__dict__[&#39;foobar&#39;] = 345</span>
                <span class="c1">#    a.foobar  # == 123</span>
                <span class="c1">#</span>
                <span class="c1"># So, a property may be returned right away.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">attr</span>

        <span class="c1"># Nothing helped, fall back.</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_object_find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oname</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find an object and return a struct with info about it.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Struct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ofind</span><span class="p">(</span><span class="n">oname</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meth</span><span class="p">,</span> <span class="n">oname</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic interface to the inspector system.</span>

<span class="sd">        This function is meant to be called by pdef, pdoc &amp; friends.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_find</span><span class="p">(</span><span class="n">oname</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
        <span class="n">docformat</span> <span class="o">=</span> <span class="n">sphinxify</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphinxify_docstring</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">found</span><span class="p">:</span>
            <span class="n">pmethod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inspector</span><span class="p">,</span> <span class="n">meth</span><span class="p">)</span>
            <span class="c1"># TODO: only apply format_screen to the plain/text repr of the mime</span>
            <span class="c1"># bundle.</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">format_screen</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">ismagic</span> <span class="k">else</span> <span class="n">docformat</span>
            <span class="k">if</span> <span class="n">meth</span> <span class="o">==</span> <span class="s1">&#39;pdoc&#39;</span><span class="p">:</span>
                <span class="n">pmethod</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">meth</span> <span class="o">==</span> <span class="s1">&#39;pinfo&#39;</span><span class="p">:</span>
                <span class="n">pmethod</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="p">,</span> <span class="n">formatter</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> 
                        <span class="n">enable_html_pager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_html_pager</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pmethod</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Object `</span><span class="si">%s</span><span class="s1">` not found.&#39;</span> <span class="o">%</span> <span class="n">oname</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;not found&#39;</span>  <span class="c1"># so callers can take other action</span>

    <span class="k">def</span> <span class="nf">object_inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oname</span><span class="p">,</span> <span class="n">detail_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get object info about oname&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_find</span><span class="p">(</span><span class="n">oname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">found</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inspector</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
                            <span class="n">detail_level</span><span class="o">=</span><span class="n">detail_level</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">oinspect</span><span class="o">.</span><span class="n">object_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">oname</span><span class="p">,</span> <span class="n">found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">object_inspect_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oname</span><span class="p">,</span> <span class="n">detail_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get object info as formatted text&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_inspect_mime</span><span class="p">(</span><span class="n">oname</span><span class="p">,</span> <span class="n">detail_level</span><span class="p">)[</span><span class="s1">&#39;text/plain&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">object_inspect_mime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oname</span><span class="p">,</span> <span class="n">detail_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get object info as a mimebundle of formatted representations.</span>

<span class="sd">        A mimebundle is a dictionary, keyed by mime-type.</span>
<span class="sd">        It must always have the key `&#39;text/plain&#39;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_object_find</span><span class="p">(</span><span class="n">oname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">found</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inspector</span><span class="o">.</span><span class="n">_get_info</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">oname</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
                            <span class="n">detail_level</span><span class="o">=</span><span class="n">detail_level</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">oname</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to history management</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up the command history, and starts regular autosaves.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span> <span class="o">=</span> <span class="n">HistoryManager</span><span class="p">(</span><span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to exception handling and tracebacks (not debugging)</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="n">debugger_cls</span> <span class="o">=</span> <span class="n">Pdb</span>

    <span class="k">def</span> <span class="nf">init_traceback_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">custom_exceptions</span><span class="p">):</span>
        <span class="c1"># Syntax error handler.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SyntaxTB</span> <span class="o">=</span> <span class="n">ultratb</span><span class="o">.</span><span class="n">SyntaxTB</span><span class="p">(</span><span class="n">color_scheme</span><span class="o">=</span><span class="s1">&#39;NoColor&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># The interactive one is initialized with an offset, meaning we always</span>
        <span class="c1"># want to remove the topmost item in the traceback, which is our own</span>
        <span class="c1"># internal code. Valid modes: [&#39;Plain&#39;,&#39;Context&#39;,&#39;Verbose&#39;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span> <span class="o">=</span> <span class="n">ultratb</span><span class="o">.</span><span class="n">AutoFormattedTB</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;Plain&#39;</span><span class="p">,</span>
                                                     <span class="n">color_scheme</span><span class="o">=</span><span class="s1">&#39;NoColor&#39;</span><span class="p">,</span>
                                                     <span class="n">tb_offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="n">check_cache</span><span class="o">=</span><span class="n">check_linecache_ipython</span><span class="p">,</span>
                                   <span class="n">debugger_cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debugger_cls</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># The instance will store a pointer to the system-wide exception hook,</span>
        <span class="c1"># so that runtime code (such as magics) can access it.  This is because</span>
        <span class="c1"># during the read-eval loop, it may get temporarily overwritten.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_excepthook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span>

        <span class="c1"># and add any custom exception handlers the user may have specified</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_custom_exc</span><span class="p">(</span><span class="o">*</span><span class="n">custom_exceptions</span><span class="p">)</span>

        <span class="c1"># Set the exception mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xmode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_custom_exc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_tuple</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set_custom_exc(exc_tuple, handler)</span>

<span class="sd">        Set a custom exception handler, which will be called if any of the</span>
<span class="sd">        exceptions in exc_tuple occur in the mainloop (specifically, in the</span>
<span class="sd">        run_code() method).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        exc_tuple : tuple of exception classes</span>
<span class="sd">            A *tuple* of exception classes, for which to call the defined</span>
<span class="sd">            handler.  It is very important that you use a tuple, and NOT A</span>
<span class="sd">            LIST here, because of the way Python&#39;s except statement works.  If</span>
<span class="sd">            you only want to trap a single exception, use a singleton tuple::</span>

<span class="sd">                exc_tuple == (MyCustomException,)</span>

<span class="sd">        handler : callable</span>
<span class="sd">            handler must have the following signature::</span>

<span class="sd">                def my_handler(self, etype, value, tb, tb_offset=None):</span>
<span class="sd">                    ...</span>
<span class="sd">                    return structured_traceback</span>

<span class="sd">            Your handler must return a structured traceback (a list of strings),</span>
<span class="sd">            or None.</span>

<span class="sd">            This will be made into an instance method (via types.MethodType)</span>
<span class="sd">            of IPython itself, and it will be called if any of the exceptions</span>
<span class="sd">            listed in the exc_tuple are caught. If the handler is None, an</span>
<span class="sd">            internal basic one is used, which just prints basic info.</span>

<span class="sd">            To protect IPython from crashes, if your handler ever raises an</span>
<span class="sd">            exception or returns an invalid result, it will be immediately</span>
<span class="sd">            disabled.</span>

<span class="sd">        WARNING: by putting in your own exception handler into IPython&#39;s main</span>
<span class="sd">        execution loop, you run a very good chance of nasty crashes.  This</span>
<span class="sd">        facility should only be used if you really know what you are doing.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc_tuple</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The custom exceptions must be given as a tuple.&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">dummy_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tb_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** Simple custom exception handler ***&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception type :&#39;</span><span class="p">,</span> <span class="n">etype</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception value:&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Traceback      :&#39;</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">validate_stb</span><span class="p">(</span><span class="n">stb</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;validate structured traceback return type</span>
<span class="sd">            </span>
<span class="sd">            return type of CustomTB *should* be a list of strings, but allow</span>
<span class="sd">            single strings or None, which are harmless.</span>
<span class="sd">            </span>
<span class="sd">            This function will *always* return a list of strings,</span>
<span class="sd">            and will raise a TypeError if stb is inappropriate.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;CustomTB must return list of strings, not </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stb</span>
            <span class="k">if</span> <span class="n">stb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stb</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">stb</span><span class="p">]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stb</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="c1"># it&#39;s a list</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stb</span><span class="p">:</span>
                <span class="c1"># check every element</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stb</span>

        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wrapped</span> <span class="o">=</span> <span class="n">dummy_handler</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">etype</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">tb</span><span class="p">,</span><span class="n">tb_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;wrap CustomTB handler, to protect IPython from user code</span>
<span class="sd">                </span>
<span class="sd">                This makes it harder (but not impossible) for custom exception</span>
<span class="sd">                handlers to crash IPython.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stb</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">etype</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">tb</span><span class="p">,</span><span class="n">tb_offset</span><span class="o">=</span><span class="n">tb_offset</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">validate_stb</span><span class="p">(</span><span class="n">stb</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># clear custom handler immediately</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_custom_exc</span><span class="p">((),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Custom TB Handler failed, unregistering&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="c1"># show the exception in handler first</span>
                    <span class="n">stb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">structured_traceback</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">stb2text</span><span class="p">(</span><span class="n">stb</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The original exception:&quot;</span><span class="p">)</span>
                    <span class="n">stb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">structured_traceback</span><span class="p">(</span>
                                            <span class="p">(</span><span class="n">etype</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">tb</span><span class="p">),</span> <span class="n">tb_offset</span><span class="o">=</span><span class="n">tb_offset</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">stb</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CustomTB</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_exceptions</span> <span class="o">=</span> <span class="n">exc_tuple</span>

    <span class="k">def</span> <span class="nf">excepthook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;One more defense for GUI apps that call sys.excepthook.</span>

<span class="sd">        GUI frameworks like wxPython trap exceptions and call</span>
<span class="sd">        sys.excepthook themselves.  I guess this is a feature that</span>
<span class="sd">        enables them to keep running after exceptions that would</span>
<span class="sd">        otherwise kill their mainloop. This is a bother for IPython</span>
<span class="sd">        which excepts to catch all of the program exceptions with a try:</span>
<span class="sd">        except: statement.</span>

<span class="sd">        Normally, IPython sets sys.excepthook to a CrashHandler instance, so if</span>
<span class="sd">        any app directly invokes sys.excepthook, it will look to the user like</span>
<span class="sd">        IPython crashed.  In order to work around this, we can disable the</span>
<span class="sd">        CrashHandler and replace it with this excepthook instead, which prints a</span>
<span class="sd">        regular traceback using our InteractiveTB.  In this fashion, apps which</span>
<span class="sd">        call sys.excepthook will generate a regular-looking exception from</span>
<span class="sd">        IPython, and the CrashHandler will only be triggered by real IPython</span>
<span class="sd">        crashes.</span>

<span class="sd">        This hook should be used sparingly, only in places which are not likely</span>
<span class="sd">        to be true IPython errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showtraceback</span><span class="p">((</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">),</span> <span class="n">tb_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_exc_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_tuple</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get exc_info from a given tuple, sys.exc_info() or sys.last_type etc.</span>
<span class="sd">        </span>
<span class="sd">        Ensures sys.last_type,value,traceback hold the exc_info we found,</span>
<span class="sd">        from whichever source.</span>
<span class="sd">        </span>
<span class="sd">        raises ValueError if none of these contain any information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exc_tuple</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">exc_tuple</span>

        <span class="k">if</span> <span class="n">etype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;last_type&#39;</span><span class="p">):</span>
                <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">last_type</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">last_value</span><span class="p">,</span> \
                                   <span class="n">sys</span><span class="o">.</span><span class="n">last_traceback</span>
        
        <span class="k">if</span> <span class="n">etype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No exception to find&quot;</span><span class="p">)</span>
        
        <span class="c1"># Now store the exception info in sys.last_type etc.</span>
        <span class="c1"># WARNING: these variables are somewhat deprecated and not</span>
        <span class="c1"># necessarily safe to use in a threaded environment, but tools</span>
        <span class="c1"># like pdb depend on their existence, so let&#39;s set them.  If we</span>
        <span class="c1"># find problems in the field, we&#39;ll need to revisit their use.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">last_type</span> <span class="o">=</span> <span class="n">etype</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">last_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">last_traceback</span> <span class="o">=</span> <span class="n">tb</span>
        
        <span class="k">return</span> <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span>
    
    <span class="k">def</span> <span class="nf">show_usage_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show a short message for UsageErrors</span>
<span class="sd">        </span>
<span class="sd">        These are special exceptions that shouldn&#39;t show a traceback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;UsageError: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exc</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_exception_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_tuple</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return as a string (ending with a newline) the exception that</span>
<span class="sd">        just occurred, without any traceback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exc_info</span><span class="p">(</span><span class="n">exc_tuple</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception_only</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">showtraceback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_tuple</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tb_offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">exception_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">running_compiled_code</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the exception that just occurred.</span>

<span class="sd">        If nothing is known about the exception, this is the method which</span>
<span class="sd">        should be used throughout the code for presenting user tracebacks,</span>
<span class="sd">        rather than directly invoking the InteractiveTB object.</span>

<span class="sd">        A specific showsyntaxerror() also exists, but this method can take</span>
<span class="sd">        care of calling it if needed, so unless you are explicitly catching a</span>
<span class="sd">        SyntaxError exception, don&#39;t try to analyze the stack manually and</span>
<span class="sd">        simply call this method.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exc_info</span><span class="p">(</span><span class="n">exc_tuple</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No traceback available to show.&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">):</span>
                <span class="c1"># Though this won&#39;t be called by syntax errors in the input</span>
                <span class="c1"># line, there may be SyntaxError cases with imported code.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showsyntaxerror</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">running_compiled_code</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">etype</span> <span class="ow">is</span> <span class="n">UsageError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show_usage_error</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exception_only</span><span class="p">:</span>
                    <span class="n">stb</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;An exception has occurred, use %tb to see &#39;</span>
                           <span class="s1">&#39;the full traceback.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
                    <span class="n">stb</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">get_exception_only</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span>
                                                                     <span class="n">value</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Exception classes can customise their traceback - we</span>
                        <span class="c1"># use this in IPython.parallel for exceptions occurring</span>
                        <span class="c1"># in the engines. This should return a list of strings.</span>
                        <span class="n">stb</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_render_traceback_</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">stb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">structured_traceback</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span>
                                            <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">tb_offset</span><span class="o">=</span><span class="n">tb_offset</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_showtraceback</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">stb</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_pdb</span><span class="p">:</span>
                        <span class="c1"># drop into debugger</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="c1"># Actually show the traceback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_showtraceback</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">stb</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exception_only</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_showtraceback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">evalue</span><span class="p">,</span> <span class="n">stb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actually show a traceback.</span>

<span class="sd">        Subclasses may override this method to put the traceback on a different</span>
<span class="sd">        place, like a side channel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">stb2text</span><span class="p">(</span><span class="n">stb</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">showsyntaxerror</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">running_compiled_code</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the syntax error that just occurred.</span>

<span class="sd">        This doesn&#39;t display a stack trace because there isn&#39;t one.</span>

<span class="sd">        If a filename is given, it is stuffed in the exception instead</span>
<span class="sd">        of what was there before (because Python&#39;s parser always uses</span>
<span class="sd">        &quot;&lt;string&gt;&quot; when reading from a string).</span>

<span class="sd">        If the syntax error occurred when running a compiled code (i.e. running_compile_code=True),</span>
<span class="sd">        longer stack trace will be displayed.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">last_traceback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exc_info</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Not the format we expect; leave it alone</span>
                <span class="k">pass</span>

        <span class="c1"># If the error occurred when executing compiled code, we should provide full stacktrace.</span>
        <span class="n">elist</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">last_traceback</span><span class="p">)</span> <span class="k">if</span> <span class="n">running_compiled_code</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">stb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SyntaxTB</span><span class="o">.</span><span class="n">structured_traceback</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">elist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_showtraceback</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">stb</span><span class="p">)</span>

    <span class="c1"># This is overridden in TerminalInteractiveShell to show a message about</span>
    <span class="c1"># the %paste magic.</span>
    <span class="k">def</span> <span class="nf">showindentationerror</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called by _run_cell when there&#39;s an IndentationError in code entered</span>
<span class="sd">        at the prompt.</span>

<span class="sd">        This is overridden in TerminalInteractiveShell to show a message about</span>
<span class="sd">        the %paste magic.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showsyntaxerror</span><span class="p">()</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to readline</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DEPRECATED</span>
<span class="sd">        </span>
<span class="sd">        Moved to terminal subclass, here only to simplify the init logic.&quot;&quot;&quot;</span>
        <span class="c1"># Set a number of methods that depend on readline to be no-op</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;`init_readline` is no-op since IPython 5.0 and is Deprecated&#39;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_custom_completer</span> <span class="o">=</span> <span class="n">no_op</span>

    <span class="nd">@skip_doctest</span>
    <span class="k">def</span> <span class="nf">set_next_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the &#39;default&#39; input string for the next command line.</span>

<span class="sd">        Example::</span>

<span class="sd">            In [1]: _ip.set_next_input(&quot;Hello Word&quot;)</span>
<span class="sd">            In [2]: Hello Word_  # cursor is here</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rl_next_input</span> <span class="o">=</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_indent_current_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the current level of indentation as a string&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_splitter</span><span class="o">.</span><span class="n">get_indent_spaces</span><span class="p">()</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to text completion</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_completer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the completion machinery.</span>

<span class="sd">        This creates completion machinery that can be used by client code,</span>
<span class="sd">        either interactively in-process (typically triggered by the readline</span>
<span class="sd">        library), programmatically (such as in test suites) or out-of-process</span>
<span class="sd">        (typically over the network by remote frontends).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">IPython.core.completer</span> <span class="k">import</span> <span class="n">IPCompleter</span>
        <span class="kn">from</span> <span class="nn">IPython.core.completerlib</span> <span class="k">import</span> <span class="p">(</span><span class="n">module_completer</span><span class="p">,</span>
                <span class="n">magic_run_completer</span><span class="p">,</span> <span class="n">cd_completer</span><span class="p">,</span> <span class="n">reset_completer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Completer</span> <span class="o">=</span> <span class="n">IPCompleter</span><span class="p">(</span><span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                     <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">,</span>
                                     <span class="n">global_namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">,</span>
                                     <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                     <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Completer</span><span class="p">)</span>

        <span class="c1"># Add custom completers to the basic ones built into IPCompleter</span>
        <span class="n">sdisp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strdispatchers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;complete_command&#39;</span><span class="p">,</span> <span class="n">StrDispatch</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strdispatchers</span><span class="p">[</span><span class="s1">&#39;complete_command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdisp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Completer</span><span class="o">.</span><span class="n">custom_completers</span> <span class="o">=</span> <span class="n">sdisp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_hook</span><span class="p">(</span><span class="s1">&#39;complete_command&#39;</span><span class="p">,</span> <span class="n">module_completer</span><span class="p">,</span> <span class="n">str_key</span> <span class="o">=</span> <span class="s1">&#39;import&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_hook</span><span class="p">(</span><span class="s1">&#39;complete_command&#39;</span><span class="p">,</span> <span class="n">module_completer</span><span class="p">,</span> <span class="n">str_key</span> <span class="o">=</span> <span class="s1">&#39;from&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_hook</span><span class="p">(</span><span class="s1">&#39;complete_command&#39;</span><span class="p">,</span> <span class="n">module_completer</span><span class="p">,</span> <span class="n">str_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%a</span><span class="s1">import&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_hook</span><span class="p">(</span><span class="s1">&#39;complete_command&#39;</span><span class="p">,</span> <span class="n">magic_run_completer</span><span class="p">,</span> <span class="n">str_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1">un&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_hook</span><span class="p">(</span><span class="s1">&#39;complete_command&#39;</span><span class="p">,</span> <span class="n">cd_completer</span><span class="p">,</span> <span class="n">str_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%c</span><span class="s1">d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_hook</span><span class="p">(</span><span class="s1">&#39;complete_command&#39;</span><span class="p">,</span> <span class="n">reset_completer</span><span class="p">,</span> <span class="n">str_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1">eset&#39;</span><span class="p">)</span>


    <span class="nd">@skip_doctest</span>
    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cursor_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the completed text and a list of completions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">           text : string</span>
<span class="sd">             A string of text to be completed on.  It can be given as empty and</span>
<span class="sd">             instead a line/position pair are given.  In this case, the</span>
<span class="sd">             completer itself will split the line like readline does.</span>

<span class="sd">           line : string, optional</span>
<span class="sd">             The complete line that text is part of.</span>

<span class="sd">           cursor_pos : int, optional</span>
<span class="sd">             The position of the cursor on the input line.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          text : string</span>
<span class="sd">            The actual text that was completed.</span>

<span class="sd">          matches : list</span>
<span class="sd">            A sorted list with all possible completions.</span>

<span class="sd">        The optional arguments allow the completion to take more context into</span>
<span class="sd">        account, and are part of the low-level completion API.</span>

<span class="sd">        This is a wrapper around the completion mechanism, similar to what</span>
<span class="sd">        readline does at the command line when the TAB key is hit.  By</span>
<span class="sd">        exposing it as a method, it can be used by other non-readline</span>
<span class="sd">        environments (such as GUIs) for text completion.</span>

<span class="sd">        Simple usage example:</span>

<span class="sd">        In [1]: x = &#39;hello&#39;</span>

<span class="sd">        In [2]: _ip.complete(&#39;x.l&#39;)</span>
<span class="sd">        Out[2]: (&#39;x.l&#39;, [&#39;x.ljust&#39;, &#39;x.lower&#39;, &#39;x.lstrip&#39;])</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Inject names into __builtin__ so we can complete on the added names.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Completer</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">cursor_pos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_custom_completer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completer</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a new custom completer function.</span>

<span class="sd">        The position argument (defaults to 0) is the index in the completers</span>
<span class="sd">        list where you want the completer to be inserted.&quot;&quot;&quot;</span>

        <span class="n">newcomp</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">completer</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Completer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Completer</span><span class="o">.</span><span class="n">matchers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">newcomp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_completer_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the frame of the completer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Completer</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Completer</span><span class="o">.</span><span class="n">global_namespace</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Completer</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Completer</span><span class="o">.</span><span class="n">global_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to magics</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_magics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">IPython.core</span> <span class="k">import</span> <span class="n">magics</span> <span class="k">as</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magics_manager</span> <span class="o">=</span> <span class="n">magic</span><span class="o">.</span><span class="n">MagicsManager</span><span class="p">(</span><span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">user_magics</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">UserMagics</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magics_manager</span><span class="p">)</span>

        <span class="c1"># Expose as public API from the magics manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_magics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magics_manager</span><span class="o">.</span><span class="n">register</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register_magics</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">AutoMagics</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">BasicMagics</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">CodeMagics</span><span class="p">,</span>
            <span class="n">m</span><span class="o">.</span><span class="n">ConfigMagics</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">DisplayMagics</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">ExecutionMagics</span><span class="p">,</span>
            <span class="n">m</span><span class="o">.</span><span class="n">ExtensionMagics</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">HistoryMagics</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">LoggingMagics</span><span class="p">,</span>
            <span class="n">m</span><span class="o">.</span><span class="n">NamespaceMagics</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">OSMagics</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">PylabMagics</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">ScriptMagics</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Register Magic Aliases</span>
        <span class="n">mman</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magics_manager</span>
        <span class="c1"># FIXME: magic aliases should be defined by the Magics classes</span>
        <span class="c1"># or in MagicsManager, not here</span>
        <span class="n">mman</span><span class="o">.</span><span class="n">register_alias</span><span class="p">(</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="s1">&#39;edit&#39;</span><span class="p">)</span>
        <span class="n">mman</span><span class="o">.</span><span class="n">register_alias</span><span class="p">(</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">)</span>
        <span class="n">mman</span><span class="o">.</span><span class="n">register_alias</span><span class="p">(</span><span class="s1">&#39;rep&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">)</span>
        <span class="n">mman</span><span class="o">.</span><span class="n">register_alias</span><span class="p">(</span><span class="s1">&#39;SVG&#39;</span><span class="p">,</span> <span class="s1">&#39;svg&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">)</span>
        <span class="n">mman</span><span class="o">.</span><span class="n">register_alias</span><span class="p">(</span><span class="s1">&#39;HTML&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">)</span>
        <span class="n">mman</span><span class="o">.</span><span class="n">register_alias</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;writefile&#39;</span><span class="p">,</span> <span class="s1">&#39;cell&#39;</span><span class="p">)</span>

        <span class="c1"># FIXME: Move the color initialization to the DisplayHook, which</span>
        <span class="c1"># should be split into a prompt manager and displayhook. We probably</span>
        <span class="c1"># even need a centralize colors management object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">)</span>
    
    <span class="c1"># Defined here so that it&#39;s included in the documentation</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">magic</span><span class="o">.</span><span class="n">MagicsManager</span><span class="o">.</span><span class="n">register_function</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">register_magic_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">magic_kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">magic_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magics_manager</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> 
                                  <span class="n">magic_kind</span><span class="o">=</span><span class="n">magic_kind</span><span class="p">,</span> <span class="n">magic_name</span><span class="o">=</span><span class="n">magic_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_line_magic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magic_name</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">_stack_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the given line magic.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        magic_name : str</span>
<span class="sd">          Name of the desired magic function, without &#39;%&#39; prefix.</span>

<span class="sd">        line : str</span>
<span class="sd">          The rest of the input line as a single string.</span>
<span class="sd">          </span>
<span class="sd">        _stack_depth : int</span>
<span class="sd">          If run_line_magic() is called from magic() then _stack_depth=2.</span>
<span class="sd">          This is added to ensure backward compatibility for use of &#39;get_ipython().magic()&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="n">magic_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_cell_magic</span><span class="p">(</span><span class="n">magic_name</span><span class="p">)</span>
            <span class="n">etpl</span> <span class="o">=</span> <span class="s2">&quot;Line magic function `</span><span class="si">%%%s</span><span class="s2">` not found</span><span class="si">%s</span><span class="s2">.&quot;</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">cm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39; (But cell magic `</span><span class="si">%%%%%s</span><span class="s1">` exists, &#39;</span>
                                    <span class="s1">&#39;did you mean that instead?)&#39;</span> <span class="o">%</span> <span class="n">magic_name</span> <span class="p">)</span>
            <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span><span class="n">etpl</span> <span class="o">%</span> <span class="p">(</span><span class="n">magic_name</span><span class="p">,</span> <span class="n">extra</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Note: this is the distance in the stack to the user&#39;s frame.</span>
            <span class="c1"># This will need to be updated if the internal calling logic gets</span>
            <span class="c1"># refactored, or else we&#39;ll be expanding the wrong variables.</span>
            
            <span class="c1"># Determine stack_depth depending on where run_line_magic() has been called</span>
            <span class="n">stack_depth</span> <span class="o">=</span> <span class="n">_stack_depth</span>
            <span class="n">magic_arg_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_expand</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">stack_depth</span><span class="p">)</span>
            <span class="c1"># Put magic args in a list so we can call with f(*a) syntax</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">magic_arg_s</span><span class="p">]</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Grab local namespace if we need it:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;needs_local_scope&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;local_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">stack_depth</span><span class="p">)</span><span class="o">.</span><span class="n">f_locals</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">run_cell_magic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magic_name</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the given cell magic.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        magic_name : str</span>
<span class="sd">          Name of the desired magic function, without &#39;%&#39; prefix.</span>

<span class="sd">        line : str</span>
<span class="sd">          The rest of the first input line as a single string.</span>

<span class="sd">        cell : str</span>
<span class="sd">          The body of the cell as a (possibly multiline) string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_cell_magic</span><span class="p">(</span><span class="n">magic_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="n">magic_name</span><span class="p">)</span>
            <span class="n">etpl</span> <span class="o">=</span> <span class="s2">&quot;Cell magic `</span><span class="si">%%{0}</span><span class="s2">` not found</span><span class="si">{1}</span><span class="s2">.&quot;</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">lm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39; (But line magic `%</span><span class="si">{0}</span><span class="s1">` exists, &#39;</span>
                            <span class="s1">&#39;did you mean that instead?)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">magic_name</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span><span class="n">etpl</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">magic_name</span><span class="p">,</span> <span class="n">extra</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">cell</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%%{0}</span><span class="s1"> is a cell magic, but the cell body is empty.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">magic_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_line_magic</span><span class="p">(</span><span class="n">magic_name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39; Did you mean the line magic %</span><span class="si">{0}</span><span class="s1"> (single %)?&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">magic_name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Note: this is the distance in the stack to the user&#39;s frame.</span>
            <span class="c1"># This will need to be updated if the internal calling logic gets</span>
            <span class="c1"># refactored, or else we&#39;ll be expanding the wrong variables.</span>
            <span class="n">stack_depth</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">magic_arg_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_expand</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">stack_depth</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">magic_arg_s</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">find_line_magic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magic_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find and return a line magic by name.</span>

<span class="sd">        Returns None if the magic isn&#39;t found.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">magics_manager</span><span class="o">.</span><span class="n">magics</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">magic_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_cell_magic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magic_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find and return a cell magic by name.</span>

<span class="sd">        Returns None if the magic isn&#39;t found.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">magics_manager</span><span class="o">.</span><span class="n">magics</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">magic_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_magic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magic_name</span><span class="p">,</span> <span class="n">magic_kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find and return a magic of the given type by name.</span>

<span class="sd">        Returns None if the magic isn&#39;t found.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">magics_manager</span><span class="o">.</span><span class="n">magics</span><span class="p">[</span><span class="n">magic_kind</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">magic_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">magic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DEPRECATED. Use run_line_magic() instead.</span>

<span class="sd">        Call a magic function by name.</span>

<span class="sd">        Input: a string containing the name of the magic function to call and</span>
<span class="sd">        any additional arguments to be passed to the magic.</span>

<span class="sd">        magic(&#39;name -opt foo bar&#39;) is equivalent to typing at the ipython</span>
<span class="sd">        prompt:</span>

<span class="sd">        In[1]: %name -opt foo bar</span>

<span class="sd">        To call a magic without arguments, simply use magic(&#39;name&#39;).</span>

<span class="sd">        This provides a proper Python function to call IPython&#39;s magics in any</span>
<span class="sd">        valid Python code you can type at the interpreter, including loops and</span>
<span class="sd">        compound statements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: should we issue a loud deprecation warning here?</span>
        <span class="n">magic_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">magic_arg_s</span> <span class="o">=</span> <span class="n">arg_s</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">magic_name</span> <span class="o">=</span> <span class="n">magic_name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">prefilter</span><span class="o">.</span><span class="n">ESC_MAGIC</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="n">magic_name</span><span class="p">,</span> <span class="n">magic_arg_s</span><span class="p">,</span> <span class="n">_stack_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to macros</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">define_macro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">themacro</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define a new macro</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the macro.</span>
<span class="sd">        themacro : str or Macro</span>
<span class="sd">            The action to do upon invoking the macro.  If a string, a new</span>
<span class="sd">            Macro object is created by passing the string to it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">IPython.core</span> <span class="k">import</span> <span class="n">macro</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">themacro</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">themacro</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">Macro</span><span class="p">(</span><span class="n">themacro</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">themacro</span><span class="p">,</span> <span class="n">macro</span><span class="o">.</span><span class="n">Macro</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A macro must be a string or a Macro instance.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">themacro</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to the running of system commands</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">system_piped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call the given cmd in a subprocess, piping stdout/err</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cmd : str</span>
<span class="sd">          Command to execute (can not end in &#39;&amp;&#39;, as background processes are</span>
<span class="sd">          not supported.  Should not be a command that expects input</span>
<span class="sd">          other than simple text.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">):</span>
            <span class="c1"># this is *far* from a rigorous test</span>
            <span class="c1"># We do not support backgrounding processes because we either use</span>
            <span class="c1"># pexpect or pipes to read from.  Users can always just call</span>
            <span class="c1"># os.system() or use ip.system=ip.system_raw</span>
            <span class="c1"># if they really want a background process.</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Background processes not supported.&quot;</span><span class="p">)</span>

        <span class="c1"># we explicitly do NOT return the subprocess status code, because</span>
        <span class="c1"># a non-None value would trigger :func:`sys.displayhook` calls.</span>
        <span class="c1"># Instead, we store the exit_code in user_ns.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s1">&#39;_exit_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_expand</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">system_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call the given cmd in a subprocess using os.system on Windows or</span>
<span class="sd">        subprocess.call using the system shell on other platforms.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cmd : str</span>
<span class="sd">          Command to execute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_expand</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># protect os.system from UNC paths on Windows, which it can&#39;t handle:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">IPython.utils._process_win32</span> <span class="k">import</span> <span class="n">AvoidUNCPath</span>
            <span class="k">with</span> <span class="n">AvoidUNCPath</span><span class="p">()</span> <span class="k">as</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;&quot;pushd </span><span class="si">%s</span><span class="s1"> &amp;&amp;&quot;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exception_only</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                    <span class="n">ec</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For posix the result of the subprocess.call() below is an exit</span>
            <span class="c1"># code, which by convention is zero for success, positive for</span>
            <span class="c1"># program failure.  Exit codes above 128 are reserved for signals,</span>
            <span class="c1"># and the formula for converting a signal to an exit code is usually</span>
            <span class="c1"># signal_number+128.  To more easily differentiate between exit</span>
            <span class="c1"># codes and signals, ipython uses negative numbers.  For instance</span>
            <span class="c1"># since control-c is signal 2 but exit code 130, ipython&#39;s</span>
            <span class="c1"># _exit_code variable will read -2.  Note that some shells like</span>
            <span class="c1"># csh and fish don&#39;t follow sh/bash conventions for exit codes.</span>
            <span class="n">executable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SHELL&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use env shell instead of default /bin/sh</span>
                <span class="n">ec</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="c1"># intercept control-C; a long traceback is not useful here</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exception_only</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">ec</span> <span class="o">=</span> <span class="mi">130</span>
            <span class="k">if</span> <span class="n">ec</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">:</span>
                <span class="n">ec</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ec</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span>
        
        <span class="c1"># We explicitly do NOT return the subprocess status code, because</span>
        <span class="c1"># a non-None value would trigger :func:`sys.displayhook` calls.</span>
        <span class="c1"># Instead, we store the exit_code in user_ns.  Note the semantics</span>
        <span class="c1"># of _exit_code: for control-c, _exit_code == -signal.SIGNIT,</span>
        <span class="c1"># but raising SystemExit(_exit_code) will give status 254!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s1">&#39;_exit_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ec</span>

    <span class="c1"># use piped system by default, because it is better behaved</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">system_piped</span>

    <span class="k">def</span> <span class="nf">getoutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get output (possibly including stderr) from a subprocess.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cmd : str</span>
<span class="sd">          Command to execute (can not end in &#39;&amp;&#39;, as background processes are</span>
<span class="sd">          not supported.</span>
<span class="sd">        split : bool, optional</span>
<span class="sd">          If True, split the output into an IPython SList.  Otherwise, an</span>
<span class="sd">          IPython LSString is returned.  These are objects similar to normal</span>
<span class="sd">          lists and strings, with a few convenience attributes for easier</span>
<span class="sd">          manipulation of line-based output.  You can use &#39;?&#39; on them for</span>
<span class="sd">          details.</span>
<span class="sd">        depth : int, optional</span>
<span class="sd">          How many frames above the caller are the local variables which should</span>
<span class="sd">          be expanded in the command string? The default (0) assumes that the</span>
<span class="sd">          expansion variables are in the stack frame calling this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">):</span>
            <span class="c1"># this is *far* from a rigorous test</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Background processes not supported.&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">getoutput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_expand</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">SList</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">LSString</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to aliases</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias_manager</span> <span class="o">=</span> <span class="n">AliasManager</span><span class="p">(</span><span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_manager</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to extensions</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_extension_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension_manager</span> <span class="o">=</span> <span class="n">ExtensionManager</span><span class="p">(</span><span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_manager</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to payloads</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payload_manager</span> <span class="o">=</span> <span class="n">PayloadManager</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">payload_manager</span><span class="p">)</span>
    
    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to the prefilter</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">init_prefilter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefilter_manager</span> <span class="o">=</span> <span class="n">PrefilterManager</span><span class="p">(</span><span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configurables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefilter_manager</span><span class="p">)</span>
        <span class="c1"># Ultimately this will be refactored in the new interpreter code, but</span>
        <span class="c1"># for now, we should expose the main prefilter method (there&#39;s legacy</span>
        <span class="c1"># code out there that may rely on this).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefilter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefilter_manager</span><span class="o">.</span><span class="n">prefilter_lines</span>

    <span class="k">def</span> <span class="nf">auto_rewrite_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print to the screen the rewritten form of the user&#39;s command.</span>

<span class="sd">        This shows visual feedback by rewriting input lines that cause</span>
<span class="sd">        automatic calling to kick in, like::</span>

<span class="sd">          /f x</span>

<span class="sd">        into::</span>

<span class="sd">          ------&gt; f(x)</span>

<span class="sd">        after the user&#39;s input prompt.  This helps the user understand that the</span>
<span class="sd">        input line was transformed automatically by IPython.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_rewritten_input</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># This is overridden in TerminalInteractiveShell to use fancy prompts</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------&gt; &quot;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to extracting values/expressions from kernel and user_ns</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_user_obj_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return simple exception dict</span>
<span class="sd">        </span>
<span class="sd">        for use in user_expressions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">etype</span><span class="p">,</span> <span class="n">evalue</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exc_info</span><span class="p">()</span>
        <span class="n">stb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InteractiveTB</span><span class="o">.</span><span class="n">get_exception_only</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">evalue</span><span class="p">)</span>
        
        <span class="n">exc_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">u</span><span class="s1">&#39;status&#39;</span> <span class="p">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;traceback&#39;</span> <span class="p">:</span> <span class="n">stb</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;ename&#39;</span> <span class="p">:</span> <span class="n">etype</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;evalue&#39;</span> <span class="p">:</span> <span class="n">py3compat</span><span class="o">.</span><span class="n">safe_unicode</span><span class="p">(</span><span class="n">evalue</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">exc_info</span>
    
    <span class="k">def</span> <span class="nf">_format_user_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;format a user object to display dict</span>
<span class="sd">        </span>
<span class="sd">        for use in user_expressions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">data</span><span class="p">,</span> <span class="n">md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span> <span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">,</span>
            <span class="s1">&#39;metadata&#39;</span> <span class="p">:</span> <span class="n">md</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">value</span>
    
    <span class="k">def</span> <span class="nf">user_expressions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expressions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate a dict of expressions in the user&#39;s namespace.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        expressions : dict</span>
<span class="sd">          A dict with string keys and string values.  The expression values</span>
<span class="sd">          should be valid Python expressions, each of which will be evaluated</span>
<span class="sd">          in the user namespace.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A dict, keyed like the input expressions dict, with the rich mime-typed</span>
<span class="sd">        display_data of each value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">user_ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span>
        <span class="n">global_ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expressions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_user_obj</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">global_ns</span><span class="p">,</span> <span class="n">user_ns</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_obj_error</span><span class="p">()</span>
            <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to the running of code</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">ex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a normal python statement in user namespace.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate python expression expr in user namespace.</span>

<span class="sd">        Returns the result of evaluation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">safe_execfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">where</span><span class="p">,</span> <span class="n">exit_ignore</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shell_futures</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A safe version of the builtin execfile().</span>

<span class="sd">        This version will never throw an exception, but instead print</span>
<span class="sd">        helpful error messages to the screen.  This only works on pure</span>
<span class="sd">        Python files with the .py extension.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : string</span>
<span class="sd">            The name of the file to be executed.</span>
<span class="sd">        where : tuple</span>
<span class="sd">            One or two namespaces, passed to execfile() as (globals,locals).</span>
<span class="sd">            If only one is given, it is passed as both.</span>
<span class="sd">        exit_ignore : bool (False)</span>
<span class="sd">            If True, then silence SystemExit for non-zero status (it is always</span>
<span class="sd">            silenced for zero status, as it is so common).</span>
<span class="sd">        raise_exceptions : bool (False)</span>
<span class="sd">            If True raise exceptions everywhere. Meant for testing.</span>
<span class="sd">        shell_futures : bool (False)</span>
<span class="sd">            If True, the code will share future statements with the interactive</span>
<span class="sd">            shell. It will both be affected by previous __future__ imports, and</span>
<span class="sd">            any __future__ imports in the code will affect the shell. If False,</span>
<span class="sd">            __future__ imports are not shared in either direction.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>

        <span class="c1"># Make sure we can open the file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Could not open file &lt;</span><span class="si">%s</span><span class="s1">&gt; for safe execution.&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Find things also in current directory.  This is needed to mimic the</span>
        <span class="c1"># behavior of running a script from the system command line, where</span>
        <span class="c1"># Python inserts the script&#39;s directory into sys.path</span>
        <span class="n">dname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">prepended_to_syspath</span><span class="p">(</span><span class="n">dname</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">glob</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">))[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">py3compat</span><span class="o">.</span><span class="n">execfile</span><span class="p">(</span>
                    <span class="n">fname</span><span class="p">,</span> <span class="n">glob</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compile</span> <span class="k">if</span> <span class="n">shell_futures</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                <span class="c1"># If the call was made with 0 or None exit status (sys.exit(0)</span>
                <span class="c1"># or sys.exit() ), don&#39;t bother showing a traceback, as both of</span>
                <span class="c1"># these are considered normal by the OS:</span>
                <span class="c1"># &gt; python -c&#39;import sys;sys.exit(0)&#39;; echo $?</span>
                <span class="c1"># 0</span>
                <span class="c1"># &gt; python -c&#39;import sys;sys.exit()&#39;; echo $?</span>
                <span class="c1"># 0</span>
                <span class="c1"># For other exit status, we show the exception unless</span>
                <span class="c1"># explicitly silenced, but only in short form.</span>
                <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">code</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">raise_exceptions</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">exit_ignore</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">showtraceback</span><span class="p">(</span><span class="n">exception_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">raise_exceptions</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="c1"># tb offset is 2 because we wrap execfile</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showtraceback</span><span class="p">(</span><span class="n">tb_offset</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">safe_execfile_ipy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">shell_futures</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raise_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like safe_execfile, but for .ipy or .ipynb files with IPython syntax.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            The name of the file to execute.  The filename must have a</span>
<span class="sd">            .ipy or .ipynb extension.</span>
<span class="sd">        shell_futures : bool (False)</span>
<span class="sd">            If True, the code will share future statements with the interactive</span>
<span class="sd">            shell. It will both be affected by previous __future__ imports, and</span>
<span class="sd">            any __future__ imports in the code will affect the shell. If False,</span>
<span class="sd">            __future__ imports are not shared in either direction.</span>
<span class="sd">        raise_exceptions : bool (False)</span>
<span class="sd">            If True raise exceptions everywhere.  Meant for testing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>

        <span class="c1"># Make sure we can open the file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Could not open file &lt;</span><span class="si">%s</span><span class="s1">&gt; for safe execution.&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Find things also in current directory.  This is needed to mimic the</span>
        <span class="c1"># behavior of running a script from the system command line, where</span>
        <span class="c1"># Python inserts the script&#39;s directory into sys.path</span>
        <span class="n">dname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">get_cells</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;generator for sequence of code blocks to run&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ipynb&#39;</span><span class="p">):</span>
                <span class="kn">from</span> <span class="nn">nbformat</span> <span class="k">import</span> <span class="n">read</span>
                <span class="n">nb</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">as_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s1">&#39;code&#39;</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">cell</span><span class="o">.</span><span class="n">source</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">prepended_to_syspath</span><span class="p">(</span><span class="n">dname</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">get_cells</span><span class="p">():</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shell_futures</span><span class="o">=</span><span class="n">shell_futures</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">raise_exceptions</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">raise_error</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">raise_exceptions</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showtraceback</span><span class="p">()</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unknown failure executing file: &lt;</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">safe_run_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">where</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A safe version of runpy.run_module().</span>

<span class="sd">        This version will never throw an exception, but instead print</span>
<span class="sd">        helpful error messages to the screen.</span>

<span class="sd">        `SystemExit` exceptions with status code 0 or None are ignored.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mod_name : string</span>
<span class="sd">            The name of the module to be executed.</span>
<span class="sd">        where : dict</span>
<span class="sd">            The globals namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">where</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">runpy</span><span class="o">.</span><span class="n">run_module</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mod_name</span><span class="p">),</span> <span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;__main__&quot;</span><span class="p">,</span>
                                     <span class="n">alter_sys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="p">)</span>
            <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">code</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showtraceback</span><span class="p">()</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unknown failure executing module: &lt;</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="n">mod_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_cell</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shell_futures</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a complete IPython cell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        raw_cell : str</span>
<span class="sd">          The code (including IPython code such as %magic functions) to run.</span>
<span class="sd">        store_history : bool</span>
<span class="sd">          If True, the raw and translated cell will be stored in IPython&#39;s</span>
<span class="sd">          history. For user code calling back into IPython&#39;s machinery, this</span>
<span class="sd">          should be set to False.</span>
<span class="sd">        silent : bool</span>
<span class="sd">          If True, avoid side-effects, such as implicit displayhooks and</span>
<span class="sd">          and logging.  silent=True forces store_history=False.</span>
<span class="sd">        shell_futures : bool</span>
<span class="sd">          If True, the code will share future statements with the interactive</span>
<span class="sd">          shell. It will both be affected by previous __future__ imports, and</span>
<span class="sd">          any __future__ imports in the code will affect the shell. If False,</span>
<span class="sd">          __future__ imports are not shared in either direction.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : :class:`ExecutionResult`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_cell</span><span class="p">(</span>
                <span class="n">raw_cell</span><span class="p">,</span> <span class="n">store_history</span><span class="p">,</span> <span class="n">silent</span><span class="p">,</span> <span class="n">shell_futures</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;post_execute&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;post_run_cell&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_run_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_cell</span><span class="p">,</span> <span class="n">store_history</span><span class="p">,</span> <span class="n">silent</span><span class="p">,</span> <span class="n">shell_futures</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal method to run a complete IPython cell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        raw_cell : str</span>
<span class="sd">        store_history : bool</span>
<span class="sd">        silent : bool</span>
<span class="sd">        shell_futures : bool</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : :class:`ExecutionResult`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">ExecutionInfo</span><span class="p">(</span>
            <span class="n">raw_cell</span><span class="p">,</span> <span class="n">store_history</span><span class="p">,</span> <span class="n">silent</span><span class="p">,</span> <span class="n">shell_futures</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ExecutionResult</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">raw_cell</span><span class="p">)</span> <span class="ow">or</span> <span class="n">raw_cell</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_execution_succeeded</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_execution_result</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">store_history</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">store_history</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">execution_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_count</span>

        <span class="k">def</span> <span class="nf">error_before_exec</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">store_history</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execution_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_before_exec</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_execution_succeeded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_execution_result</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;pre_execute&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="s1">&#39;pre_run_cell&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

        <span class="c1"># If any of our input transformation (input_transformer_manager or</span>
        <span class="c1"># prefilter_manager) raises an exception, we store it in this variable</span>
        <span class="c1"># so that we can display the error after logging the input and storing</span>
        <span class="c1"># it in the history.</span>
        <span class="n">preprocessing_exc_tuple</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Static input transformations</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_transformer_manager</span><span class="o">.</span><span class="n">transform_cell</span><span class="p">(</span><span class="n">raw_cell</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="n">preprocessing_exc_tuple</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">raw_cell</span>  <span class="c1"># cell has to exist so it can be stored/logged</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Dynamic transformations - only applied for single line commands</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># use prefilter_lines to handle trailing newlines</span>
                        <span class="c1"># restore trailing newline for ast.parse</span>
                        <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefilter_manager</span><span class="o">.</span><span class="n">prefilter_lines</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># don&#39;t allow prefilter errors to crash IPython</span>
                        <span class="n">preprocessing_exc_tuple</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

        <span class="c1"># Store raw and processed history</span>
        <span class="k">if</span> <span class="n">store_history</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">store_inputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_count</span><span class="p">,</span>
                                              <span class="n">cell</span><span class="p">,</span> <span class="n">raw_cell</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">raw_cell</span><span class="p">)</span>

        <span class="c1"># Display the exception if input processing failed.</span>
        <span class="k">if</span> <span class="n">preprocessing_exc_tuple</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showtraceback</span><span class="p">(</span><span class="n">preprocessing_exc_tuple</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">store_history</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execution_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">error_before_exec</span><span class="p">(</span><span class="n">preprocessing_exc_tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Our own compiler remembers the __future__ environment. If we want to</span>
        <span class="c1"># run code with a separate __future__ environment, use the default</span>
        <span class="c1"># compiler</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span> <span class="k">if</span> <span class="n">shell_futures</span> <span class="k">else</span> <span class="n">CachingCompiler</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
            <span class="n">cell_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_count</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_trap</span><span class="p">:</span>
                <span class="c1"># Compile to bytecode</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">code_ast</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">ast_parse</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">cell_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_exceptions</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CustomTB</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">error_before_exec</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndentationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">showindentationerror</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">error_before_exec</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OverflowError</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span>
                        <span class="ne">MemoryError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">showsyntaxerror</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">error_before_exec</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                <span class="c1"># Apply AST transformations</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">code_ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_ast</span><span class="p">(</span><span class="n">code_ast</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InputRejected</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">showtraceback</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">error_before_exec</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                <span class="c1"># Give the displayhook a reference to our ExecutionResult so it</span>
                <span class="c1"># can fill in the output value.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayhook</span><span class="o">.</span><span class="n">exec_result</span> <span class="o">=</span> <span class="n">result</span>

                <span class="c1"># Execute the user code</span>
                <span class="n">interactivity</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span> <span class="k">if</span> <span class="n">silent</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast_node_interactivity</span>
                <span class="n">has_raised</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_ast_nodes</span><span class="p">(</span><span class="n">code_ast</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">cell_name</span><span class="p">,</span>
                   <span class="n">interactivity</span><span class="o">=</span><span class="n">interactivity</span><span class="p">,</span> <span class="n">compiler</span><span class="o">=</span><span class="n">compiler</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">last_execution_succeeded</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">has_raised</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_execution_result</span> <span class="o">=</span> <span class="n">result</span>

                <span class="c1"># Reset this so later displayed values do not modify the</span>
                <span class="c1"># ExecutionResult</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayhook</span><span class="o">.</span><span class="n">exec_result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">store_history</span><span class="p">:</span>
            <span class="c1"># Write output to the database. Does nothing unless</span>
            <span class="c1"># history output logging is enabled.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">store_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_count</span><span class="p">)</span>
            <span class="c1"># Each cell is a *single* input, regardless of how many lines it has</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execution_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span> <span class="nf">transform_ast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the AST transformations from self.ast_transformers</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node : ast.Node</span>
<span class="sd">          The root node to be transformed. Typically called with the ast.Module</span>
<span class="sd">          produced by parsing user input.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        An ast.Node corresponding to the node it was called with. Note that it</span>
<span class="sd">        may also modify the passed object, so don&#39;t rely on references to the</span>
<span class="sd">        original AST.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast_transformers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InputRejected</span><span class="p">:</span>
                <span class="c1"># User-supplied AST transformers can reject an input by raising</span>
                <span class="c1"># an InputRejected.  Short-circuit in this case so that we</span>
                <span class="c1"># don&#39;t unregister the transform.</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;AST transformer </span><span class="si">%r</span><span class="s2"> threw an error. It will be unregistered.&quot;</span> <span class="o">%</span> <span class="n">transformer</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ast_transformers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">transformer</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast_transformers</span><span class="p">:</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>
                

    <span class="k">def</span> <span class="nf">run_ast_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodelist</span><span class="p">:</span><span class="n">ListType</span><span class="p">[</span><span class="n">AST</span><span class="p">],</span> <span class="n">cell_name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">interactivity</span><span class="o">=</span><span class="s1">&#39;last_expr&#39;</span><span class="p">,</span>
                        <span class="n">compiler</span><span class="o">=</span><span class="nb">compile</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a sequence of AST nodes. The execution mode depends on the</span>
<span class="sd">        interactivity parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nodelist : list</span>
<span class="sd">          A sequence of AST nodes to run.</span>
<span class="sd">        cell_name : str</span>
<span class="sd">          Will be passed to the compiler as the filename of the cell. Typically</span>
<span class="sd">          the value returned by ip.compile.cache(cell).</span>
<span class="sd">        interactivity : str</span>
<span class="sd">          &#39;all&#39;, &#39;last&#39;, &#39;last_expr&#39; , &#39;last_expr_or_assign&#39; or &#39;none&#39;,</span>
<span class="sd">          specifying which nodes should be run interactively (displaying output</span>
<span class="sd">          from expressions). &#39;last_expr&#39; will run the last node interactively</span>
<span class="sd">          only if it is an expression (i.e. expressions in loops or other blocks</span>
<span class="sd">          are not displayed) &#39;last_expr_or_assign&#39; will run the last expression</span>
<span class="sd">          or the last assignment. Other values for this parameter will raise a</span>
<span class="sd">          ValueError.</span>
<span class="sd">        compiler : callable</span>
<span class="sd">          A function with the same interface as the built-in compile(), to turn</span>
<span class="sd">          the AST nodes into code objects. Default is the built-in compile().</span>
<span class="sd">        result : ExecutionResult, optional</span>
<span class="sd">          An object to store exceptions that occur during execution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        True if an exception occurred while running code, False if it finished</span>
<span class="sd">        running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nodelist</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">interactivity</span> <span class="o">==</span> <span class="s1">&#39;last_expr_or_assign&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodelist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">_assign_nodes</span><span class="p">):</span>
                <span class="n">asg</span> <span class="o">=</span> <span class="n">nodelist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">asg</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">asg</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">asg</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">asg</span><span class="p">,</span> <span class="n">_single_targets_nodes</span><span class="p">):</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">asg</span><span class="o">.</span><span class="n">target</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                    <span class="n">nnode</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()))</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">nnode</span><span class="p">)</span>
                    <span class="n">nodelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nnode</span><span class="p">)</span>
            <span class="n">interactivity</span> <span class="o">=</span> <span class="s1">&#39;last_expr&#39;</span>

        <span class="k">if</span> <span class="n">interactivity</span> <span class="o">==</span> <span class="s1">&#39;last_expr&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nodelist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">):</span>
                <span class="n">interactivity</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interactivity</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>

        <span class="k">if</span> <span class="n">interactivity</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">to_run_exec</span><span class="p">,</span> <span class="n">to_run_interactive</span> <span class="o">=</span> <span class="n">nodelist</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">interactivity</span> <span class="o">==</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span>
            <span class="n">to_run_exec</span><span class="p">,</span> <span class="n">to_run_interactive</span> <span class="o">=</span> <span class="n">nodelist</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">nodelist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">interactivity</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">to_run_exec</span><span class="p">,</span> <span class="n">to_run_interactive</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">nodelist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Interactivity was </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">interactivity</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">to_run_exec</span><span class="p">):</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">([</span><span class="n">node</span><span class="p">])</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">compiler</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">cell_name</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">to_run_interactive</span><span class="p">):</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Interactive</span><span class="p">([</span><span class="n">node</span><span class="p">])</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">compiler</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">cell_name</span><span class="p">,</span> <span class="s2">&quot;single&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># Flush softspace</span>
            <span class="k">if</span> <span class="n">softspace</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">()</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># It&#39;s possible to have exceptions raised here, typically by</span>
            <span class="c1"># compilation of odd code (such as a naked &#39;return&#39; outside a</span>
            <span class="c1"># function) that did parse but isn&#39;t valid. Typically the exception</span>
            <span class="c1"># is a SyntaxError, but it&#39;s safest just to catch anything and show</span>
            <span class="c1"># the user a traceback.</span>

            <span class="c1"># We do only one try/except outside the loop to minimize the impact</span>
            <span class="c1"># on runtime, and also because if any node in the node list is</span>
            <span class="c1"># broken, we should stop execution completely.</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_before_exec</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showtraceback</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">run_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code_obj</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a code object.</span>

<span class="sd">        When an exception occurs, self.showtraceback() is called to display a</span>
<span class="sd">        traceback.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        code_obj : code object</span>
<span class="sd">          A compiled code object, to be executed</span>
<span class="sd">        result : ExecutionResult, optional</span>
<span class="sd">          An object to store exceptions that occur during execution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        False : successful execution.</span>
<span class="sd">        True : an error occurred.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set our own excepthook in case the user code tries to call it</span>
        <span class="c1"># directly, so that the IPython crash handler doesn&#39;t get triggered</span>
        <span class="n">old_excepthook</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">excepthook</span>

        <span class="c1"># we save the original sys.excepthook in the instance, in case config</span>
        <span class="c1"># code (such as magics) needs access to it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_excepthook</span> <span class="o">=</span> <span class="n">old_excepthook</span>
        <span class="n">outflag</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># happens in more places, so it&#39;s easier as default</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">pre_run_code_hook</span><span class="p">()</span>
                <span class="c1">#rprint(&#39;Running code&#39;, repr(code_obj)) # dbg</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">code_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Reset our crash handler in place</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">old_excepthook</span>
        <span class="k">except</span> <span class="ne">SystemExit</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_in_exec</span> <span class="o">=</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showtraceback</span><span class="p">(</span><span class="n">exception_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;To exit: use &#39;exit&#39;, &#39;quit&#39;, or Ctrl-D.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_exceptions</span><span class="p">:</span>
            <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_in_exec</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CustomTB</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_in_exec</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showtraceback</span><span class="p">(</span><span class="n">running_compiled_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">outflag</span>

    <span class="c1"># For backwards compatibility</span>
    <span class="n">runcode</span> <span class="o">=</span> <span class="n">run_code</span>

    <span class="k">def</span> <span class="nf">check_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return whether a block of code is ready to execute, or should be continued</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : string</span>
<span class="sd">          Python input code, which can be multiline.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        status : str</span>
<span class="sd">          One of &#39;complete&#39;, &#39;incomplete&#39;, or &#39;invalid&#39; if source is not a</span>
<span class="sd">          prefix of valid code.</span>
<span class="sd">        indent : str</span>
<span class="sd">          When status is &#39;incomplete&#39;, this is some whitespace to insert on</span>
<span class="sd">          the next line of the prompt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">nspaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_splitter</span><span class="o">.</span><span class="n">check_complete</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nspaces</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to GUI support and pylab</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="n">active_eventloop</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">enable_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gui</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Implement enable_gui in a subclass&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">enable_matplotlib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gui</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable interactive matplotlib and inline figure support.</span>
<span class="sd">        </span>
<span class="sd">        This takes the following steps:</span>
<span class="sd">        </span>
<span class="sd">        1. select the appropriate eventloop and matplotlib backend</span>
<span class="sd">        2. set up matplotlib for interactive use with that backend</span>
<span class="sd">        3. configure formatters for inline figure display</span>
<span class="sd">        4. enable the selected gui eventloop</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gui : optional, string</span>
<span class="sd">          If given, dictates the choice of matplotlib GUI backend to use</span>
<span class="sd">          (should be one of IPython&#39;s supported backends, &#39;qt&#39;, &#39;osx&#39;, &#39;tk&#39;,</span>
<span class="sd">          &#39;gtk&#39;, &#39;wx&#39; or &#39;inline&#39;), otherwise we use the default chosen by</span>
<span class="sd">          matplotlib (as dictated by the matplotlib build-time options plus the</span>
<span class="sd">          user&#39;s matplotlibrc configuration file).  Note that not all backends</span>
<span class="sd">          make sense in all contexts, for example a terminal ipython can&#39;t</span>
<span class="sd">          display figures inline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">IPython.core</span> <span class="k">import</span> <span class="n">pylabtools</span> <span class="k">as</span> <span class="n">pt</span>
        <span class="n">gui</span><span class="p">,</span> <span class="n">backend</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">find_gui_and_backend</span><span class="p">(</span><span class="n">gui</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pylab_gui_select</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">gui</span> <span class="o">!=</span> <span class="s1">&#39;inline&#39;</span><span class="p">:</span>
            <span class="c1"># If we have our first gui selection, store it</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pylab_gui_select</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pylab_gui_select</span> <span class="o">=</span> <span class="n">gui</span>
            <span class="c1"># Otherwise if they are different</span>
            <span class="k">elif</span> <span class="n">gui</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pylab_gui_select</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Cannot change to a different GUI toolkit: </span><span class="si">%s</span><span class="s1">.&#39;</span>
                        <span class="s1">&#39; Using </span><span class="si">%s</span><span class="s1"> instead.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gui</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pylab_gui_select</span><span class="p">))</span>
                <span class="n">gui</span><span class="p">,</span> <span class="n">backend</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">find_gui_and_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pylab_gui_select</span><span class="p">)</span>
        
        <span class="n">pt</span><span class="o">.</span><span class="n">activate_matplotlib</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">configure_inline_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
        
        <span class="c1"># Now we must activate the gui pylab wants to use, and fix %run to take</span>
        <span class="c1"># plot updates into account</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_gui</span><span class="p">(</span><span class="n">gui</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magics_manager</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;ExecutionMagics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default_runner</span> <span class="o">=</span> \
            <span class="n">pt</span><span class="o">.</span><span class="n">mpl_runner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_execfile</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">gui</span><span class="p">,</span> <span class="n">backend</span>

    <span class="k">def</span> <span class="nf">enable_pylab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gui</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">import_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">welcome_message</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Activate pylab support at runtime.</span>

<span class="sd">        This turns on support for matplotlib, preloads into the interactive</span>
<span class="sd">        namespace all of numpy and pylab, and configures IPython to correctly</span>
<span class="sd">        interact with the GUI event loop.  The GUI backend to be used can be</span>
<span class="sd">        optionally selected with the optional ``gui`` argument.</span>
<span class="sd">        </span>
<span class="sd">        This method only adds preloading the namespace to InteractiveShell.enable_matplotlib.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gui : optional, string</span>
<span class="sd">          If given, dictates the choice of matplotlib GUI backend to use</span>
<span class="sd">          (should be one of IPython&#39;s supported backends, &#39;qt&#39;, &#39;osx&#39;, &#39;tk&#39;,</span>
<span class="sd">          &#39;gtk&#39;, &#39;wx&#39; or &#39;inline&#39;), otherwise we use the default chosen by</span>
<span class="sd">          matplotlib (as dictated by the matplotlib build-time options plus the</span>
<span class="sd">          user&#39;s matplotlibrc configuration file).  Note that not all backends</span>
<span class="sd">          make sense in all contexts, for example a terminal ipython can&#39;t</span>
<span class="sd">          display figures inline.</span>
<span class="sd">        import_all : optional, bool, default: True</span>
<span class="sd">          Whether to do `from numpy import *` and `from pylab import *`</span>
<span class="sd">          in addition to module imports.</span>
<span class="sd">        welcome_message : deprecated</span>
<span class="sd">          This argument is ignored, no welcome message will be displayed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">IPython.core.pylabtools</span> <span class="k">import</span> <span class="n">import_pylab</span>
        
        <span class="n">gui</span><span class="p">,</span> <span class="n">backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_matplotlib</span><span class="p">(</span><span class="n">gui</span><span class="p">)</span>
        
        <span class="c1"># We want to prevent the loading of pylab to pollute the user&#39;s</span>
        <span class="c1"># namespace as shown by the %who* magics, so we execute the activation</span>
        <span class="c1"># code in an empty namespace, and we update *both* user_ns and</span>
        <span class="c1"># user_ns_hidden with this information.</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">import_pylab</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">import_all</span><span class="p">)</span>
        <span class="c1"># warn about clobbered names</span>
        <span class="n">ignored</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">}</span>
        <span class="n">both</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">ignored</span><span class="p">)</span>
        <span class="n">clobbered</span> <span class="o">=</span> <span class="p">[</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">both</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns_hidden</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gui</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">clobbered</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Utilities</span>
    <span class="c1">#-------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">var_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="n">DollarFormatter</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Expand python variables in a string.</span>

<span class="sd">        The depth argument indicates how many frames above the caller should</span>
<span class="sd">        be walked to look for the local namespace where to expand variables.</span>

<span class="sd">        The global namespace for expansion is always the user&#39;s interactive</span>
<span class="sd">        namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># This is thrown if there aren&#39;t that many frames on the stack,</span>
            <span class="c1"># e.g. if a script called run_line_magic() directly.</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># We have to use .vformat() here, because &#39;self&#39; is a valid and common</span>
            <span class="c1"># name, and expanding **ns for .format() would make it collide with</span>
            <span class="c1"># the &#39;self&#39; argument of the method.</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">vformat</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># if formatter couldn&#39;t format, just let it go untransformed</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">mktempfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;ipython_edit_&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a new tempfile and return its filename.</span>

<span class="sd">        This makes a call to tempfile.mkstemp (created in a tempfile.mkdtemp),</span>
<span class="sd">        but it registers the created filename internally so ipython cleans it up</span>
<span class="sd">        at exit time.</span>

<span class="sd">        Optional inputs:</span>

<span class="sd">          - data(None): if data is given, it gets written out to the temp file</span>
<span class="sd">            immediately, and the file is closed again.&quot;&quot;&quot;</span>

        <span class="n">dirname</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>

        <span class="n">handle</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">dirname</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>  <span class="c1"># On Windows, there can only be one open handle on a file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">tmp_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">tmp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">tmp_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">filename</span>

    <span class="nd">@undoc</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DEPRECATED: Write a string to the default output&quot;&quot;&quot;</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;InteractiveShell.write() is deprecated, use sys.stdout instead&#39;</span><span class="p">,</span>
             <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@undoc</span>
    <span class="k">def</span> <span class="nf">write_err</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DEPRECATED: Write a string to the default error output&quot;&quot;&quot;</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;InteractiveShell.write_err() is deprecated, use sys.stderr instead&#39;</span><span class="p">,</span>
             <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ask_yes_no</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interrupt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ask_yes_no</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span><span class="n">default</span><span class="p">,</span><span class="n">interrupt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show a usage message&quot;&quot;&quot;</span>
        <span class="n">page</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">IPython</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">interactive_usage</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_input_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">range_str</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return as a string a set of input history slices.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        range_str : string</span>
<span class="sd">            The set of slices is given as a string, like &quot;~5/6-~4/2 4:8 9&quot;,</span>
<span class="sd">            since this function is for use by magic functions which get their</span>
<span class="sd">            arguments as strings. The number before the / is the session</span>
<span class="sd">            number: ~n goes n back from the current session.</span>

<span class="sd">        raw : bool, optional</span>
<span class="sd">            By default, the processed input is used.  If this is true, the raw</span>
<span class="sd">            input history is used instead.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Slices can be described with two notations:</span>

<span class="sd">        * ``N:M`` -&gt; standard python form, means including items N...(M-1).</span>
<span class="sd">        * ``N-M`` -&gt; include items N..M (closed endpoint).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">get_range_by_str</span><span class="p">(</span><span class="n">range_str</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_user_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">py_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_encoding_cookie</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">search_ns</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a code string from history, file, url, or a string or macro.</span>

<span class="sd">        This is mainly used by magic functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        target : str</span>

<span class="sd">          A string specifying code to retrieve. This will be tried respectively</span>
<span class="sd">          as: ranges of input history (see %history for syntax), url,</span>
<span class="sd">          corresponding .py file, filename, or an expression evaluating to a</span>
<span class="sd">          string or Macro in the user namespace.</span>

<span class="sd">        raw : bool</span>
<span class="sd">          If true (default), retrieve raw history. Has no effect on the other</span>
<span class="sd">          retrieval mechanisms.</span>

<span class="sd">        py_only : bool (default False)</span>
<span class="sd">          Only try to fetch python code, do not try alternative methods to decode file</span>
<span class="sd">          if unicode fails.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A string of code.</span>

<span class="sd">        ValueError is raised if nothing is found, and TypeError if it evaluates</span>
<span class="sd">        to an object of another type. In each case, .args[0] is a printable</span>
<span class="sd">        message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_input_lines</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">)</span>  <span class="c1"># Grab history</span>
        <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">code</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="s1">&#39;https://&#39;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">openpy</span><span class="o">.</span><span class="n">read_py_url</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">skip_encoding_cookie</span><span class="o">=</span><span class="n">skip_encoding_cookie</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">py_only</span> <span class="p">:</span>
                <span class="c1"># Deferred import</span>
                <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="k">import</span> <span class="n">urlopen</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; seem to be unreadable.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">target</span><span class="p">)</span>

        <span class="n">potential_target</span> <span class="o">=</span> <span class="p">[</span><span class="n">target</span><span class="p">]</span>
        <span class="k">try</span> <span class="p">:</span>
            <span class="n">potential_target</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">get_py_filename</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">for</span> <span class="n">tgt</span> <span class="ow">in</span> <span class="n">potential_target</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tgt</span><span class="p">):</span>                        <span class="c1"># Read file</span>
                <span class="k">try</span> <span class="p">:</span>
                    <span class="k">return</span> <span class="n">openpy</span><span class="o">.</span><span class="n">read_py_file</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">skip_encoding_cookie</span><span class="o">=</span><span class="n">skip_encoding_cookie</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">py_only</span> <span class="p">:</span>
                        <span class="k">with</span> <span class="n">io_open</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span> <span class="p">:</span>
                            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; seem to be unreadable.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">target</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">tgt</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is a directory, not a regular file.&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">search_ns</span><span class="p">:</span>
            <span class="c1"># Inspect namespace to load object source</span>
            <span class="n">object_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_inspect</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">detail_level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">object_info</span><span class="p">[</span><span class="s1">&#39;found&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">object_info</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">object_info</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>                                              <span class="c1"># User namespace</span>
            <span class="n">codeobj</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; was not found in history, as a file, url, &quot;</span>
                                <span class="s2">&quot;nor in the user namespace.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">codeobj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">codeobj</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">codeobj</span><span class="p">,</span> <span class="n">Macro</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">value</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is neither a string nor a macro.&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="p">,</span>
                        <span class="n">codeobj</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="c1"># Things related to IPython exiting</span>
    <span class="c1">#-------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">atexit_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will be executed at the time of exit.</span>

<span class="sd">        Cleanup operations and saving of persistent data that is done</span>
<span class="sd">        unconditionally by IPython should be performed here.</span>

<span class="sd">        For things that may depend on startup flags or platform specifics (such</span>
<span class="sd">        as having readline or not), register a separate atexit function in the</span>
<span class="sd">        code that has the appropriate information, rather than trying to</span>
<span class="sd">        clutter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Close the history session (this stores the end time and line count)</span>
        <span class="c1"># this must be *before* the tempfile cleanup, in case of temporary</span>
        <span class="c1"># history db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">end_session</span><span class="p">()</span>

        <span class="c1"># Cleanup all tempfiles and folders left around</span>
        <span class="k">for</span> <span class="n">tfile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempfiles</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">tfile</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">for</span> <span class="n">tdir</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempdirs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Clear all user namespaces to release all references cleanly.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">new_session</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Run user hooks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="o">.</span><span class="n">shutdown_hook</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore_sys_module_state</span><span class="p">()</span>


    <span class="c1"># Overridden in terminal subclass to change prompts</span>
    <span class="k">def</span> <span class="nf">switch_doctest_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">InteractiveShellABC</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An abstract base class for InteractiveShell.&quot;&quot;&quot;</span>

<span class="n">InteractiveShellABC</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">InteractiveShell</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, BedRock Systems, Inc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>